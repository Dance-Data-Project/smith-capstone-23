---
title: "Retrieve Endowment Funds"
author: "Rose Evard"
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    df_print: paged
    code_folding: hide
---

```{r, message = FALSE}

library(tidyverse)
library(kableExtra)
library(lubridate)
library(forcats)

knitr::opts_chunk$set(message = FALSE)

```

> An important question: Does ZERO in a boolean situation mean false or mean NA?  There are cases where 1s and 0s are coded for T/F.

```{r retrieving endowment info}
endowment_data <- read_rds("./data/endowment_filter_data_990.RDS")

## Example Table of 0s and 1s as T/Fs
endowment_data %>% 
  pull(EndowmentsHeldRelatedOrgInd) %>% 
  unique()
```


```{r}
##Graphing difference between beginning and end periods
endowment_data %>%
  select(ReturnDate, EIN, CYBeginningYearBalanceAmt, CYEndYearBalanceAmt) %>%
  pivot_longer(cols = c(CYBeginningYearBalanceAmt, CYEndYearBalanceAmt), names_to = "Period", values_to = "Balance") %>%
  mutate(Period = as.factor(Period)) %>%
  mutate(Year = substr(ReturnDate, 1, 4)) %>%
  ggplot(aes(x = Period, y = Balance, group = EIN)) +
  facet_wrap(~Year) +
  geom_point(alpha = 0.5) + 
  geom_line(alpha = 0.5) + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 35, hjust =1),
        legend.position = "none") +
  labs(title = "Comparing Fiscal Year Beginning and End Endowment Totals") +
  scale_y_continuous(labels = scales::label_dollar())
```


## Determining Which Needed to File Schedule D for Endowment

Not all those that fill out schedule D do so for endowment, so I focused on Question 10 "Did the organization, directly or through a related organization, hold assets in temporarily restricted endowments, permanent endowments, or quasi endowments?  If "yes," complete Schedule D, Part V".  

```{r}
##Identifying those that DID fill out schedule D for Endowment, as they supplied info in any numeric column
##Assuming the sum of from cols 4-31 (schedule D finances) is not zero
filed_schd_d <- endowment_data %>%
 mutate(FilledSchD = ifelse(rowSums(across(CYBeginningYearBalanceAmt:TermEndowmentBalanceEOYPct), na.rm = TRUE) != 0, TRUE, FALSE)) %>%
  select(ReturnDate, EIN, DonorRstrOrQuasiEndowmentsInd, FilledSchD)

##Counting those that needed to fill schedule D
endowment_data %>%
  group_by(DonorRstrOrQuasiEndowmentsInd) %>%
  summarize(n = n()) %>%
  kbl(caption = "Total EINs checked YES on Q10") %>%
  kable_material()

##Seeing those that DID and or DID NOT need to fill out Schedule D, yet Did or Did Not
filed_schd_d %>%
  group_by(DonorRstrOrQuasiEndowmentsInd, FilledSchD) %>%
  summarize(n = n()) %>%
  kbl(caption = "990 Q10 answer and If They Filled out Schedule D") %>%
  kable_material()
```

> Editor's note: Prior to filtering the data for 990T and amended files, there were ones that marked Q10 as true, approximately 20 of them.  
> Secondary Note: once the filtering updates, these tables will change.
