---
title: "Retrieve Endowment Funds"
author: "Rose Evard"
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    df_print: paged
    code_folding: hide
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = "./output_html")})
---

```{r, message = FALSE}

library(tidyverse)
library(kableExtra)
library(lubridate)
library(forcats)

knitr::opts_chunk$set(message = FALSE)

```

```{r}

# make kable table with consistent formatting
make_table <- function(..., title = "", col_names = c("")) {
  title <- paste0("<center><span style = 'font-size:150%;color:black'><b>",
                  title,
                  "</span></b><center>")
   as_tibble(...) %>%
    kbl(caption = title,
        col.names = col_names) %>%
    kable_material() %>%
    row_spec(row=0, background = "#43494C" , color = "white", bold = TRUE)
}

```

> Note: Zero was coded as false and One as true for Checkbox questions.


```{r retrieving endowment info}
endowment_data <- read_rds("./data/endowment_filter_data_990.RDS")
```


```{r}
##Graphing difference between beginning and end periods  

endowment_data %>%
  select(ReturnDate, EIN, CYBeginningYearBalanceAmt, CYEndYearBalanceAmt) %>%
  pivot_longer(cols = c(CYBeginningYearBalanceAmt, CYEndYearBalanceAmt), names_to = "Period", values_to = "Balance") %>%
  mutate(Period = as.factor(Period)) %>%
  mutate(Year = substr(ReturnDate, 1, 4)) %>%
  ggplot(aes(x = Period, y = Balance, group = EIN)) +
  facet_wrap(~Year) +
  geom_point(alpha = 0.5) + 
  geom_line(alpha = 0.5) + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 35, hjust =1),
        legend.position = "none") +
  labs(title = "Comparing Fiscal Year Beginning and End Endowment Totals") +
  scale_y_continuous(labels = scales::label_dollar())
```

## Which Years and Companies Filled out Schedule D  

```{r}
##Identifying those that DID fill out schedule D for Endowment, as they supplied info in any numeric column
##Assuming the sum of from cols 4-31 (schedule D finances) is not zero
filed_schd_d <- endowment_data %>%
 mutate(Filled_Sch_D = ifelse(rowSums(across(CYBeginningYearBalanceAmt:TermEndowmentBalanceEOYPct), na.rm = TRUE) != 0, "Yes", "No")) %>%
  select(TaxPeriodBeginDt, TaxPeriodEndDt, ReturnDate, EIN, DonorRstrOrQuasiEndowmentsInd, Filled_Sch_D) %>%
  mutate(Need_Sch_D = case_when(is.na(DonorRstrOrQuasiEndowmentsInd) ~ "NA",
                                DonorRstrOrQuasiEndowmentsInd == TRUE ~ "Yes",
                                DonorRstrOrQuasiEndowmentsInd == FALSE ~ "No")) %>%
  select(-DonorRstrOrQuasiEndowmentsInd)
```

```{r}
filed_schd_d %>%
  select(EIN, Filled_Sch_D) %>%
  filter(Filled_Sch_D == "Yes") %>%
  group_by(EIN) %>%
  summarize(num_times_fil_sche_D = n()) %>%
  arrange(desc(num_times_fil_sche_D)) %>%
  make_table(title = "EINs that filled out Schedule D at least once", col_names = c("EIN", "# Times Schedule D was filled out")) %>%
  scroll_box(height = "450px")
```

There are 47 EINs which, at one point, have filled out Schedule D. 

```{r}
#How many unique schedule D's are there
filed_schd_d %>%
 select(EIN, Filled_Sch_D) %>%
  filter(Filled_Sch_D == "Yes") %>%
  summarize(num_sch_d = n()) %>%
  make_table(title = "Total Number of Unique Schedule D's", col_names = c("Total"))  %>%
  row_spec(row = 0:1, align = "center")
```

There are 241 uniquely filed Schedule D's. 

```{r}
filed_schd_d %>%
  select(TaxPeriodBeginDt, EIN, Filled_Sch_D) %>%
  filter(Filled_Sch_D == "Yes") %>%
  mutate(year = substr(TaxPeriodBeginDt, 1, 4)) %>%
  group_by(year) %>%
  summarize(num_sch_d_in_year = n()) %>%
  arrange(desc(year)) %>%
  make_table(title = "Years with Schedule D Filed", col_names = c("Year", "Total Schedule D's filed within the year"))
```

Years represented in the data are 2014-2020, based on the beginning financial year date. 


## Determining Which Needed to File Schedule D for Endowment

Not all those that fill out schedule D do so for endowment, so I focused on Question 10 "Did the organization, directly or through a related organization, hold assets in temporarily restricted endowments, permanent endowments, or quasi endowments?  If "yes," complete Schedule D, Part V".  

```{r}
##Counting those that needed to fill schedule D
filed_schd_d %>%
  group_by(Need_Sch_D) %>%
  summarize(n = n()) %>%
  arrange(desc(Need_Sch_D)) %>%
  make_table(title = "Total EINs checked YES on Q10", col_names = c("Need Schedule D on Q10", "Total Filings"))

##Seeing those that DID and or DID NOT need to fill out Schedule D, yet Did or Did Not
filed_schd_d %>%
  group_by(Need_Sch_D, Filled_Sch_D) %>%
  summarize(n = n()) %>%
  arrange(desc(Need_Sch_D)) %>%
  make_table(title = "Whether Individual 990 Filings Needed Schedule D", col_names = c("Need Schedule D on Q10", "Filed Schedule D", "Total Filings"))
```

Total which needed schedule D and proceeded to file it matches total who filed it previously.  

# Examining Gaps in Filing Schedule D's  
         
```{r}

filed_schd_d %>%
  filter(Filled_Sch_D == "Yes") %>%
  mutate(time = interval(TaxPeriodBeginDt, TaxPeriodEndDt),
         time = as.numeric(time, "days")) %>%
  group_by(EIN) %>%
  mutate(sum_coverage = sum(time)) %>%
  ggplot(aes(xmin = as.Date(TaxPeriodBeginDt, "%Y-%m-%d"), 
             xmax = TaxPeriodEndDt, 
             y = EIN)) +
  geom_linerange(size = 1, alpha = .8) +
  theme_bw() +
  theme(plot.title = element_text(size = 20, face = "bold", hjust = .5),
        axis.title = element_text(size = 16, face = "bold"),
        plot.subtitle = element_text(size = 16, face = "italic", hjust = .5),
        axis.text.x = element_text(size = 11,angle=20, vjust = .7),
        axis.text.y = element_text(size = 4),
        strip.text = element_text(face="bold",size = 18)) +
  scale_x_date(date_breaks = "12 months",
               date_labels = "%b %Y") +
  labs(y = "EIN",
       x = "Date",
       title = "Schedule D submission by EIN")
```

```{r}
ein_with_sch_d <- filed_schd_d %>%
  filter(Filled_Sch_D == "Yes") %>%
  group_by(EIN) %>%
  summarize(n = n()) %>%
  pull(EIN) 

filed_schd_d %>%
  filter(EIN %in% ein_with_sch_d) %>%
  mutate(time = interval(TaxPeriodBeginDt, TaxPeriodEndDt),
         time = as.numeric(time, "days")) %>%
  group_by(EIN) %>%
  mutate(sum_coverage = sum(time)) %>%
  ggplot(aes(xmin = as.Date(TaxPeriodBeginDt, "%Y-%m-%d"), 
             xmax = TaxPeriodEndDt, 
             y = EIN)) +
  geom_linerange(size = 1, alpha = .8) +
  theme_bw() +
  theme(plot.title = element_text(size = 20, face = "bold", hjust = .5),
        axis.title = element_text(size = 16, face = "bold"),
        plot.subtitle = element_text(size = 16, face = "italic", hjust = .5),
        axis.text.x = element_text(size = 11,angle=20, vjust = .7),
        axis.text.y = element_text(size = 4),
        strip.text = element_text(face="bold",size = 18)) +
  scale_x_date(date_breaks = "12 months",
               date_labels = "%b %Y") +
  labs(y = "EIN",
       x = "Date",
       title = "Gaps in Filing for \n EINs with Schedule D Gaps")
```

> Now: Find those who have different schedule D submissions from their 990 submissions 