---
title: "Endowment Tme Series for Report"
author: "Quinn White"
date: "`r Sys.Date()`"
output: 
  pdf_document:
    latex_engine: xelatex
    toc: true
header-includes:
  - \usepackage{fontspec}
  - \setmainfont{Helvetica}
  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, fig.width =15, fig.height=8, fig.pos = "H", out.extra = "")
```

<style>
.math {
  font-size: small;
}
</style>

Definitions:

* `OtherExpendituresAmt`: Other expenditures for facilities and programs


```{r packages and theme}
library(tidyverse)
library(kableExtra)
library(scales)
library(plotly)
library(glue)
library(here)
library(viridis)
library(ggrepel)

all_plots <- FALSE

m <- list(
    l = 50,
    r = 50,
    b = 200,
    t = 150,
    pad = 0.5
)


theme_c <- function(...){ 
   # font <- "Helvetica"   #assign font family up front
    theme_bw() %+replace%    #replace elements we want to change
    
    theme(
      
      
      #text elements
      plot.title = element_text(             #title
                   size = 14,                #set font size
                   face = 'bold',            #bold typeface
                   hjust = .5,
                   vjust = 3),               
      
      plot.subtitle = element_text(          #subtitle
                   size = 12,
                   hjust = .5,
                   face = 'italic',
                   vjust = 3),               #font size
      
      axis.title = element_text(             #axis titles
                   size =14,
                   face="bold"),               #font size
      
      axis.text.x = element_text(              #axis text
                   size = 12),
      legend.text = element_text(size = 10),
      legend.title = element_text(size = 11, face="bold"),
      # t, r, b, l
      plot.margin = unit(c(1,.5,.5,.5), "cm"),
      legend.position = "right",
      strip.text.x = element_text(size = 18, 
                                  # face = "bold",
                                  color="white",
                                  margin=margin(4,0,4,0),
                                  lineheight=1),
       strip.text.y = element_text(size = 18, 
                                  # face = "bold",
                                   color="white", 
                                   angle=-90, 
                                   lineheight = 1,
                                   margin=margin(4,0,4,0)),
      strip.background = element_rect(fill = "#3E3D3D")
      ) %+replace%
      theme(...)
   
}



```

```{r load data, eval=TRUE}

# load companies file of EIN to name and endowment data

companies_to_ein <- readRDS(here("data", "companies.RDS")) 


companies_to_ein <- companies_to_ein %>%
  mutate(organization_name = ifelse(
    organization_name == "Ballet Hispanico", 
    "Ballet Hisp√°nico",
    organization_name))


endowment_data <- read_rds(here("data", 
                                "endowments_by_most_recent_filings.RDS")) %>%
  select(-c(EndowmentsHeldUnrelatedOrgInd, EndowmentsHeldRelatedOrgInd)) %>%
  pivot_longer(-c(EIN, fiscal_year),
               names_to = "variable_name") %>%
  left_join(companies_to_ein) %>%
  mutate(fiscal_year=as.numeric(paste(fiscal_year)),
         organization_name = ifelse(is.na(organization_name),
                                    EIN, organization_name))






```

```{r extract dates,eval=FALSE}
# extract return dates
source(here("GET_VARS.R"))

files <- dir(here("ballet_990_released_20230208"),
              full.names = TRUE)


dates <- map_df(files,
                ~get_df(filename = .x, 
                        variables = c("//Return//ReturnHeader//TaxPeriodEndDt",
                                      "//Return//ReturnHeader//TaxPeriodBeginDt"))) %>%
  mutate(fiscal_year = as.numeric(paste(fiscal_year))) %>%
   filter_ein()

saveRDS(dates, here('data', 'dates.RDS')) 

```






```{r sp500, eval=TRUE}

dates <- readRDS( here('data', 'dates.RDS')) %>%
  select(EIN, TaxPeriodEndDt, TaxPeriodBeginDt, fiscal_year) 
 

endowment_data <- endowment_data %>%
  mutate(fiscal_year=as.numeric(paste(fiscal_year))) %>%
  left_join(dates)


endowment_data_wide <- endowment_data %>% 
  pivot_wider(names_from=variable_name,
              values_from=value) %>%
  mutate(begin_week = week(TaxPeriodBeginDt),
         begin_month = month(TaxPeriodBeginDt),
         begin_year = year(TaxPeriodBeginDt),
         end_week = week(TaxPeriodEndDt),
         end_month = month(TaxPeriodEndDt),
         end_year = year(TaxPeriodEndDt))



# no data in sp&500 for week 53 in these years, so change to 52
years_52 <- c(2011, 2017)


# fill week, month from previous years
# adjust year depending on whether the fiscal year is across years or not
endowment_data_wide <- endowment_data_wide %>%
  # select(EIN, TaxPeriodBeginDt, TaxPeriodEndDt,
  #        fiscal_year, contains("month"), 
  #        contains("year"), contains("week")) %>%
  group_by(EIN) %>%
  arrange(fiscal_year) %>%
  mutate(diffyears = any(begin_year != end_year, na.rm=TRUE)) %>%
  fill(c(begin_month, begin_week, end_month, end_week), .direction="up") %>%
  mutate(begin_year = ifelse(diffyears == TRUE, fiscal_year - 1, fiscal_year),
         end_year = fiscal_year) %>%
  ungroup() %>%
  mutate(end_week = ifelse(end_week == 53 & end_year %in% years_52, 52, end_week))



  
# source: https://www.investing.com/indices/us-spx-500-historical-data
sp <- read_csv(here('data','SP500_historical.csv'))



sp <- sp %>%
  rename_with(tolower) %>%
  select( sp500 = open, date) %>%
  mutate(sp500 = as.numeric(sp500),
         date = as_date(date, format= "%m/%d/%Y")) %>%
  filter(!is.na(sp500)) %>%
  mutate(
         year = year(date),
         week = week(date))  %>%
  group_by(week, year) %>%
  summarize(sp500 = mean(sp500,na.rm=TRUE),
            .groups ="drop") %>%
  group_by(year) %>%
  mutate(maxweek = max(week))


# shift up 1 by one week so we are joining by lagged week
sp <- sp %>% 
  mutate(week_new = ifelse(week ==maxweek, 1, week+1),
         year_new = ifelse(week == maxweek, year+1, year)) %>%
  select(sp500, week = week_new, year = year_new)



endowment_data_wide <- endowment_data_wide %>%
  # select(EIN, TaxPeriodBeginDt, TaxPeriodEndDt,
  #        fiscal_year, contains("month"), 
  #        contains("year"), contains("week")) %>%
  group_by(EIN) %>%
  arrange(fiscal_year) %>%
  mutate(diffyears = any(begin_year != end_year, na.rm=TRUE)) %>%
  fill(c(begin_month, begin_week, end_month, end_week), .direction="up") %>%
  mutate(begin_year = ifelse(diffyears == TRUE, fiscal_year - 1, fiscal_year),
         end_year = fiscal_year) %>%
  ungroup()

# renaming columns
sp_start <- sp %>%
  select(week, year, sp500_begin = sp500)
sp_end <- sp %>%
  select(week, year, sp500_end = sp500)

end_sp <- endowment_data_wide %>%
  left_join(sp_start, by = c('begin_week' = 'week',
                             'begin_year' = 'year')) %>%
  left_join(sp_end,  by = c('end_week' = 'week',
                             'end_year' = 'year'))

end_sp %>% filter(is.na(sp500_begin) | is.na(sp500_end)) %>% 
  select(EIN, TaxPeriodEndDt, 
         TaxPeriodBeginDt, 
         begin_week, 
         begin_year,
         sp500_begin,
         sp500_end)

```


## Annual Growth Rate

The annual growth rate is the percentage change in a year. That is,

$$\text{growth rate} = \dfrac{\text{Beginning Value}- \text{End Value}}{\text{Beginning Value}}.$$ 
We can compute this for the S&P 500 for the same time interval. Here, we use mean value of the S&P 500 to the previous week compared to the beginning and end dates of each company's fiscal year. 



To account for withdrawals and contributions, we add back withdrawals and subtract contributions, so we calculate the annual growth rate as

$$\small \text{Annual Growth Rate} = \dfrac{ ( \text{End Value} + \text{Other Expenditures} + \text{Grants and Scholarships} + \text{Administrative Expenses} - \text{Contributions} ) -\text{Beginning Value}}{\text{Beginning Value}}$$ 
This adjustment is important because we want to see how much of the change from the beginning of year balance to the end of year balance is due to the investments, not, for example, a large contribution.


```{r, fig.height = 15, fig.cap = "\\label{fig:annual-growth-endowment}Annual growth rate of a company's endowment when adjusting for contributions and withdrawals, compared to the annual growth S\\&P 500 for the corresponding time period."}

# top_20 <- end_sp %>%
#   group_by(organization_name) %>%
#   summarize(mean_balance = mean(BeginningYearBalanceAmt, na.rm=TRUE)) %>%
#   slice_max(mean_balance, n = 20)

# replace NAs with 0's
end_sp <-  end_sp %>%
  mutate(across(c(AdministrativeExpensesAmt, OtherExpendituresAmt,
                  ContributionsAmt, GrantsOrScholarshipsAmt,
                  BeginningYearBalanceAmt, EndYearBalanceAmt), ~ifelse(is.na(.x), 0, .x))) %>%
  filter(BeginningYearBalanceAmt != 0)


top_20 <- end_sp %>%
  group_by(organization_name) %>%
  summarize(mean_balance = mean(BeginningYearBalanceAmt, na.rm=TRUE)) 


end_sp %>%
  inner_join(top_20) %>%
  mutate(pct_change_adjusted = (EndYearBalanceAmt + OtherExpendituresAmt + 
                     GrantsOrScholarshipsAmt +  AdministrativeExpensesAmt
                   - ContributionsAmt - BeginningYearBalanceAmt ) / BeginningYearBalanceAmt
         ) %>%
  mutate(organization_name = fct_reorder(organization_name,mean_balance, .desc=TRUE)) %>%
  mutate(pct_change_sp = (sp500_end - sp500_begin) / sp500_begin) %>%
  select(contains("pct_change"), organization_name, fiscal_year) %>%
  pivot_longer(c(contains('pct_change'))) %>%
  mutate(name = case_when(
    name == "pct_change_sp" ~ "Growth Rate of S&P 500",
    name == "pct_change_adjusted" ~ "Growth Rate of Adjusted Endowment Balance"
  )) %>%
  ggplot(aes(x = fiscal_year, y = value, color = name)) +
  geom_line() +
  geom_point(alpha = .5, size = .3, show.legend=FALSE) +
  facet_wrap(~organization_name, scales= "free_y", ncol=4) +
  theme_c() +
  scale_x_continuous(breaks = 2010:2021) +
  scale_y_continuous(labels=scales::percent) +
  scale_color_manual(values=c("#51B09A","#C59742")) +
  labs(x = "Date",
       y = "Percent Change",
       color = "",
       title = "Annual Growth of S&P 500 Compared to ",
       subtitle = "Top 15 Companies by Size of Endowment") +
  theme(legend.position = "top",
        plot.title = element_text(size = 25),
        plot.subtitle = element_text(size =20),
        legend.text=element_text(size =17),
        axis.text.x = element_text(size = 12, angle=30),
        strip.text = element_text(size =14)) +
  guides(color = guide_legend(override.aes = list(linewidth=2)))






```


```{r,eval=FALSE,include=FALSE}

# not adjusted 
end_sp %>%
  inner_join(top_20) %>%
  mutate(organization_name = fct_reorder(organization_name,mean_balance, .desc=TRUE)) %>%
  mutate(pct_change_sp = (sp500_end - sp500_begin) / sp500_begin,
         pct_change_endowment = (EndYearBalanceAmt - BeginningYearBalanceAmt) / BeginningYearBalanceAmt) %>%
  select(pct_change_sp,pct_change_endowment, organization_name, fiscal_year) %>%
  pivot_longer(c(contains('pct_change'))) %>%
  ggplot(aes(x = fiscal_year, y = value, color = name)) +
  geom_line() +
  geom_point(alpha = .5, size = .3, show.legend=FALSE) +
  facet_wrap(~organization_name, scales= "free_y", ncol=4) +
  theme_c(axis.text.x = element_text(size = 12)) +
  scale_x_continuous(breaks = 2010:2021) +
  scale_y_continuous(labels=scales::percent) +
  scale_color_manual(values=c("#51B09A","#C59742")) +
  labs(x = "Date",
       y = "Percent Change",
       color = "",
       title = "Annual Growth of S&P 500 Compared to ",
       subtitle = "Top 15 Companies by Size of Endowment") +
  theme(legend.position = "top",
        plot.title = element_text(size = 25),
        plot.subtitle = element_text(size =20)) +
  guides(color = guide_legend(override.aes = list(linewidth=2)))









```

## Compound Growth Rate

Letting $t$ denote the number of years considered, 
$$\text{Compound Annual Growth Rate} = \left( \dfrac{\text{End Value}}{\text{Beginning Value}}\right)^{\dfrac{1}{t}}-1$$
To adjust for contributions and expenditures, we define the Compound Annual Growth Rate as


$$\small\left( \dfrac{\text{End Value} + \sum_{i=1}^{t-1} \text{Other Expenditures} +  \sum_{i=1}^{t-1}\text{Grants and Scholarships} +  \sum_{i=1}^{t-1} \text{Administrative Expenses} - \sum_{i=1}^{t-1} \text{Contributions}  }{\text{Beginning Value}} \right)^{\dfrac{1}{t}}-1$$
We visualize the compound growth rates for all companies in Figure \ref{fig:compound-growth}. Notably, San Francisco Ballet, Joffrey Ballet, and 

```{r, fig.cap = "\\label{fig:compound-growth}Compound annual growth rates for all organizations compared to the compound annual growth rate for the S\\&P 500.", fig.width = 17, fig.height=9}

cagr <- end_sp %>%
    filter(fiscal_year <= 2020) %>%
  group_by(organization_name) %>%
  mutate(minyear = min(fiscal_year),
         maxyear = max(fiscal_year)) %>%
  mutate(across(c(AdministrativeExpensesAmt, OtherExpendituresAmt,
                  ContributionsAmt, GrantsOrScholarshipsAmt), ~ifelse(fiscal_year == maxyear, NA, .x))) %>%
  filter(BeginningYearBalanceAmt != 0) %>%
  select(minyear, maxyear, organization_name, contains("Amt"), fiscal_year, contains('sp')) %>%
  group_by(organization_name, minyear, maxyear) %>%
  summarize(cont = sum(ContributionsAmt, na.rm = TRUE),
            exp = sum(OtherExpendituresAmt, na.rm= TRUE),
            grants = sum(GrantsOrScholarshipsAmt, na.rm=TRUE),
            admin = sum(AdministrativeExpensesAmt, na.rm=TRUE),
            endowment_begin = BeginningYearBalanceAmt[which.min(fiscal_year)],
            endowment_end = BeginningYearBalanceAmt[which.max(fiscal_year)],
            sp_begin = sp500_begin[which.min(fiscal_year)],
            sp_end = sp500_begin[which.max(fiscal_year)],
            .groups="drop",
            n_years = unique(maxyear)- unique(minyear)) %>%
  mutate(cagr_adj =   ((endowment_end + exp + grants + admin - cont)/endowment_begin)^(1/n_years) - 1,
         cagr_sp = (sp_end/sp_begin)^(1/n_years) -1)


cagr %>%
  select(cagr_adj, cagr_sp, organization_name) %>%
  mutate(order = cagr_adj) %>%
  pivot_longer(contains('cagr')) %>%
  mutate(name=case_when(
    name == "cagr_adj" ~ "Compound Annual Growth Rate\nfor Endowment",
    name == "cagr_sp" ~ "Compound Annual Growth Rate\nin S&P 500"
  )) %>%
  mutate(xlab = ifelse(value > 0, value+ .007, value-.008)) %>%
  ggplot(aes(y = fct_reorder(organization_name, order),
             x = value, fill = name)) +
  geom_bar(stat="identity",position = position_dodge(1.2), width=.8)+
  labs(y = "",
       x= "Compound Annual Growth Rate",
       fill = "") +
  theme_c(legend.spacing.y = unit(4, 'cm')) + 
  theme(axis.text.y  =element_text(size = 14),
        legend.text=element_text(size = 14)) +
  scale_fill_manual(values=c("#51B09A","#C59742")) +
  scale_x_continuous(labels = scales::percent, n.breaks = 6) +
  geom_text(aes(y= organization_name, x =xlab, label=paste0(round(100*value), '%')),
            #nudge_x = .1,
            size = 3,
            position=position_dodge(.9),
            hjust=0) 


```

We see immediately in Figure \ref{fig:compound-growth}that some companies have a compound growth rate is indistinguishable from zero. This includes:

- Oregon Ballet: reported no investment earnings/losses for any year
- Harlem Ballet: investment earnings/gains were extremely small ($\pm 13$ dollars)
- First State Ballet Theatre: reported no investment earnings/losses for any year
- Eugene Ballet: only reported investment earnings/losses for 2020 and 2021
- American Repertory Ballet: reported no investment earnings/losses for any year

We see in \ref{fig:annual-growth-endowment} that each of these companies annual growth rates are essentially zero when accounting for contributions and withdrawals.

```{r plot_ranks function}

# function to plot variables of interest against each other
plot_ranks <- function(var1, var2, data) {

  
   plt <- data %>%
    group_by(fiscal_year) %>%
   # arrange(var1) %>%
    mutate("{var1}_rank" := rank(-!!sym(var1)), na.last = "keep") %>%
#    arrange(var2) %>%
    mutate("{var2}_rank"  := rank(-!!sym(var2)),  na.last = "keep") %>%
    ggplot(aes(x = !!sym(glue("{var1}_rank" )), y =!!sym(glue("{var2}_rank" )),
               color  = organization_name,
               label =EIN
               )) +
    geom_point() +
    geom_function(fun=function(x)x,color="darkred", alpha = .8) +
    labs(x = paste0(var1, " Rank"),
         y =  paste0(var2, " Rank")) +
    theme_bw() +
    labs(title = glue("Rank of {var2} vs. Rank of {var1}")) +
    viridis::scale_color_viridis(discrete=TRUE,
                                 option = "rocket",
                                 end = .9) +
     facet_wrap(~fiscal_year)+
      theme(plot.title = element_text(size = 14, 
                                      hjust = .5, face="bold",),
            plot.subtitle = element_text(hjust = .5, 
                                         face="italic",
                                         size = 14),
            axis.title = element_text(size = 13, 
                                      face = "bold")) 
  
  ggplotly(plt, margin = m, height = 550) %>%
    partial_bundle()

}


plot_ranks_by_consistency <- function(var1, var2, data) {

  
   plt <- data %>%
     filter(fiscal_year > 2010 & fiscal_year < 2021) %>%
    group_by(fiscal_year) %>%
   # arrange(var1) %>%
    mutate("{var1}_rank" := rank(-!!sym(var1)), na.last = "keep") %>%
#    arrange(var2) %>%
    mutate("{var2}_rank"  := rank(-!!sym(var2)),  na.last = "keep")  %>%
     mutate(rank_diff = !!sym(glue("{var2}_rank")) - !!sym(glue("{var1}_rank" ))) %>%
   group_by(EIN) %>%
   mutate(sum_pos = sum(rank_diff >0, na.rm=TRUE),
          sum_neg = sum(rank_diff < 0,  na.rm=TRUE),
          sum_zero = sum(rank_diff ==0, na.rm=TRUE))%>%
     ungroup() %>% 
   mutate(prop_positive = sum_pos / (sum_pos + sum_neg + sum_zero)) %>%
    ggplot(aes(x = !!sym(glue("{var1}_rank" )), y =!!sym(glue("{var2}_rank" )),
               color  = prop_positive,
               group =organization_name
               )) +
    geom_function(fun=function(x)x,color="darkred", alpha = .8, n =201) +
    geom_point() +
    labs(x = paste0(var1, " Rank"),
         y =  paste0(var2, " Rank"),
         title = glue("Rank of {var2} vs. Rank of {var1}"),
         color = glue("Proportion of Years Where\n{var1}\nRanked Higher than\n{var2}")) +
    theme_c(legend.text=element_text(size =8)) +
    scale_color_gradient2(high="#5935CF", low="#D18E01", mid="#E2E2E2", limits=c(0,1), midpoint=.5) +
     facet_wrap(~fiscal_year, ncol=5)+
      theme(plot.title = element_text(size = 12, 
                                      hjust = .5, face="bold",),
            plot.subtitle = element_text(hjust = .5, 
                                         face="italic",
                                         size = 14),
            axis.title = element_text(size = 13, 
                                      face = "bold")) +
     scale_x_reverse() +
     scale_y_reverse()
  
  return(plt)

}




```




```{r, eval=TRUE}

vars <-  unique(endowment_data$variable_name)[!grepl("EOY|Admin|Grants", unique(endowment_data$variable_name))]

# pairwise combinations of variables
variable_combinations <- t(combn(vars, 2)) %>%
  as.data.frame()

if (!all_plots) variable_combinations <- variable_combinations[1:4,]


```



### Where Endowments are Held


```{r,eval=FALSE}

  

#######################################
# CREATE BIG PALETTE WITH MANY COLORS
#######################################

pal1 <- viridis_pal(option="mako", end = .9)(12)
pal2 <- viridis_pal(option="rocket", end = .8)(12)
pal3 <- viridis_pal(option="magma", end = .9)(12)
pal4 <- viridis_pal(option="inferno", end = .8)(12)

set.seed(123)
pal <- c(pal1, pal2, pal3, pal4)
indexes <- sample.int(length(pal), replace=FALSE)
pal <- pal[indexes]


```

```{r}



#######################################
# CREATE BIG PALETTE WITH MANY COLORS
#######################################
pal1 <- viridis_pal(option="mako", end = .9, begin=.2)(10)
pal2 <- viridis_pal(option="rocket", end = .9, begin=.2)(8)
pal3 <- viridis_pal(option="magma", end = .9, begin=.2)(8)
pal4 <- viridis_pal(option="inferno", end = .9, begin=.2)(8)

set.seed(999)
pal <- c(pal1, pal2, pal3, pal4)
indexes <- sample.int(length(pal), replace=FALSE)
pal <- pal[indexes]



```

```{r, results='asis'}



###################################################################################################
# table of organization that had endowment in single category for all years on file
###################################################################################################

all_category <- endowment_data_wide %>%
  filter(!if_all(contains("EOY"), is.na)) %>%
  select(contains("EOY"),fiscal_year, 
         EIN, organization_name) %>%
   group_by(organization_name) %>%
    summarize(n_years = sum(!is.na(BoardDesignatedBalanceEOYPct) |
                              !is.na(PrmnntEndowmentBalanceEOYPct) |
                              !is.na(TermEndowmentBalanceEOYPct)),
              across(contains("EOY"),~ mean(.x, na.rm=TRUE))) %>%
   filter(if_any(contains("EOY"), ~.x==1 )) %>%
   pivot_longer(contains("EOY")) %>%
  filter(!is.na(value)) %>%
  mutate(name = case_when(
    name == "TermEndowmentBalanceEOYPct" ~ "Temporarily restricted endowment",
    name == "PrmnntEndowmentBalanceEOYPct" ~ "Permanent endowment",
    name == "BoardDesignatedBalanceEOYPct" ~ "Board designated or quasi-endowment"
  )) %>%
  group_by(name, n_years) %>%
  summarize(organization_name = paste0(organization_name, collapse =", ")) %>%
  arrange(name, desc(n_years)) %>%
  select(`Organization Name`=organization_name,
         `Endowment Type` = name,
         `Number of Years on File` = n_years) 

all_category%>%
  select(-`Endowment Type`) %>%
   kbl(caption = "Organizations with $100\\%$ of their Endowments in One Category for All Years on File",
       format="latex",
       booktabs=TRUE,
       escape=FALSE,
       linesep = "\\addlinespace") %>%
  column_spec(2, width = "4cm") %>%
    pack_rows(index = table(all_category$`Endowment Type`),  hline_after=TRUE,
                latex_gap_space = "0.5em",
)


  
  

###################################################################################################
# table of organization that had endowment in single category for all years on file
###################################################################################################
#  endowment_data_wide %>%
#   select(contains("EOY"),fiscal_year, 
#          EIN, organization_name) %>%
#    group_by(organization_name) %>%
#    summarize(across(contains("EOY"),~ mean(.x, na.rm=TRUE))) %>%
#    filter(if_any(contains("EOY"), ~.x==1 )) %>%
#    pivot_longer(contains("EOY")) %>%
#   mutate(name = case_when(
#     name == "TermEndowmentBalanceEOYPct" ~ "Temporarily restricted endowment",
#     name == "PrmnntEndowmentBalanceEOYPct" ~ "Permanent endowment",
#     name == "BoardDesignatedBalanceEOYPct" ~ "Board designated or quasi-endowment"
#   )) %>%
#    filter(!is.na(value) & value !=0) %>%
#    group_by(name) %>%
#    summarize(`Organization Name` = paste0(organization_name, collapse = "\n"),
#              `Number of Organizations` = n()) %>%
#    select(`Endowment Type` = name, 
#           `Organization Name`, `Number of Organizations`) %>%
#  #   mutate(`Organization Name` = linebreak(`Organization Name`)) %>%
#    kbl(caption = "Organizations with $100\\%$ of their Endowments in One Category for All Years on File",
#        format="latex",
#        booktabs=TRUE,
#        escape=FALSE,
#        linesep = "\\addlinespace") %>%
# #   row_spec(row=0, color="white", background="#3E3D3D") %>%
#    column_spec(2, width = "4cm")

```

```{r, fig.width=14, fig.height=16, fig.cap="\\label{fig:endowment-type}The percentage of endowments held in temporarily restricted endowment, permanent endowment, or board designated or quasi-endowment. The first row of plots corresponds to the percentages for companies ranked in the top 15 by beginning of year balance, and the second row includes all remaining companies."}


# eins that have endowments that are in a single category for all years
all_in_one_category <- endowment_data_wide %>%
  select(contains("EOY"),fiscal_year, 
         EIN, organization_name) %>%
   group_by(organization_name) %>%
   summarize(across(contains("EOY"),~ mean(.x, na.rm=TRUE))) %>%
   filter(if_any(contains("EOY"), ~.x==1 )) %>%
  pull(organization_name) %>% 
  unique()

endowment_data_wide_filt <- endowment_data_wide %>%
  filter(!organization_name %in% all_in_one_category)

####################################################################################
# split labels into 2 groups, one labeled on earliest date, one on latest
####################################################################################
set.seed(999)
all_eins <- unique(endowment_data_wide_filt$EIN)
all_eins <- endowment_data_wide_filt %>% 
  # arrange(desc(BeginningYearBalanceAmt)) %>%
  # select(EIN, organization_name) %>%
  # distinct() %>%
  pull(EIN) %>%
  unique()

indexes_all <- 1:length(all_eins)
first <- sample.int(floor(length(all_eins)/2), replace=FALSE)
ein_beginning <- all_eins[first]
ein_end <- all_eins[indexes_all[!indexes_all %in% first]]
ein_end = all_eins[indexes_all]


ranks <- endowment_data_wide_filt %>%
  filter(fiscal_year <= 2020) %>%
  group_by(organization_name) %>%
  summarize(fiscal_year = max(fiscal_year),
            BeginningYearBalanceAmt = BeginningYearBalanceAmt[which.max(fiscal_year)]) %>%
  mutate(rank = rank(-BeginningYearBalanceAmt)) 

top_20 <- ranks %>% filter(rank <= 15)
not_top_20 <- ranks %>% filter(rank >15)

  

dat <- endowment_data_wide_filt %>%
  select(contains("EOY"),fiscal_year, 
         EIN, organization_name) %>%
  mutate(rank_category = ifelse(organization_name %in% top_20$organization_name,
                                "Endowment Ranked\nin Top 15", 
                                "Endowment Not Ranked\nin Top 15")) %>%
  mutate(rank_category=factor(rank_category,
                              levels = c( "Endowment Ranked\nin Top 15",
                                          "Endowment Not Ranked\nin Top 15"))) %>%
  pivot_longer(cols = contains("EOY"))  %>%
  mutate(name = case_when(
    name == "TermEndowmentBalanceEOYPct" ~ "Temporarily restricted\nendowment",
    name == "PrmnntEndowmentBalanceEOYPct" ~ "Permanent endowment",
    name == "BoardDesignatedBalanceEOYPct" ~ "Board designated\nor quasi-endowment"
  )) %>%
  filter(!is.na(value)) %>%
  group_by(organization_name, name) %>%
  mutate(xlabel = ifelse(EIN %in% ein_beginning,
                         min(fiscal_year),
                         max(fiscal_year)),
         value=100*value,
         ylabel = ifelse(EIN %in% ein_beginning,
                         value[which.min(fiscal_year)],
                         value[which.max(fiscal_year)]) )

dat_labels <- dat %>%
  select(organization_name,xlabel,ylabel,name,rank_category) %>%
  distinct()


 dat %>%
   ggplot(aes(x=fiscal_year,
             y  = value, 
             color = organization_name)) +
  geom_line(show.legend=FALSE,
            alpha = .95) +
  facet_wrap(~name) +
  theme_c(
    strip.text = element_text(margin =margin(6,0,6,0),
                                    size =4,
                                    lineheight=.5),
        #  strip.text.y = element_text(angle=-90, color="white", size =18),
          legend.position="none",
        axis.title = element_text(size =16),
    axis.text.x = element_text(angle = 30),
    plot.title = element_text(             #title
                   size = 30,                #set font size
                   face = 'bold',            #bold typeface
                   hjust = .5,
                   vjust = 3)) +
  scale_color_manual(values=pal) +
   geom_point(size=.5, alpha =.5) +
  labs(y="Percentage of Endowment in Category",
       x = "Fiscal Year") +
  geom_label_repel(aes(label = organization_name,
                 y = ylabel,
                 x = xlabel,  
                 color=organization_name),
             size = 3,
             seed=124,
             data=dat_labels,
              min.segment.length=9,
             label.size = 1.2,
             force=.8,
           #  nudge_x = -.5,
             # direction="y",
             force_pull = 20,
             max.overlaps = 20) +
  geom_label_repel(aes(label = organization_name,
                color=organization_name,
                 y = ylabel, x = xlabel),
              color = "black",
             label.size = NA,
             size = 3,
            # nudge_x = -.5,
             seed=124,
             data=dat_labels,
             min.segment.length=9,
             force=.8,
             # direction="y",
             force_pull=20,
             max.overlaps = 20) +
   facet_grid(rank_category~name, scales="free") +
   scale_x_continuous(limits=c(2013,2022), breaks=2014:2021) +
   scale_y_continuous(limits = c(-5, 105), breaks = seq(0,100, by = 20)) +
   labs(title = "Types of Endowments by Organization")



  
  
```


# Rankings 


## Beginning of Year Balance versus Contributions 



```{r, fig.cap = "\\label{fig:balancecont} Comparing the rankings of beginning of year balance of the endowment to the ranking of contributions recieved."}




######################################
# PLOTTING RANKS AGAINST EACH OTHER
######################################

plot_ranks_by_consistency("BeginningYearBalanceAmt",
                          "ContributionsAmt",
                          data = endowment_data_wide) +
  labs(title = "Rank of Contributions versus\nRank of Beginning of Year Endowment Balance",
       y = "Rank of Contributions",
       x = "Rank of Beginning of Year Balance",
       color = "Proportion of Years Where\n Beginning of Year Balance\n Ranked Higher than\nContributions")  + 
  theme(axis.text.x = element_text(size =9),
        axis.text.y=  element_text(size =9),
        axis.title = element_text(size=20),
        legend.text = element_text(size = 12),
        legend.title=element_text(size = 16),
        strip.text=element_text(size = 16, color = "white"),
        plot.title=element_text(hjust = .5, face="bold", size = 25)) 



```

```{r,fig.cap = "\\label{fig:balancecontbar} Comparing the Proportion of years where a company ranked higher, lower, or the same in beginning of year balance compared to contributions received.", fig.height= 10, fig.width=15}



var1 <- "BeginningYearBalanceAmt"
var2 <- "ContributionsAmt"


prop_balanced_ranked_higher <- endowment_data_wide %>%
     filter(fiscal_year > 2010 & fiscal_year < 2021) %>%
    group_by(fiscal_year) %>%
   # arrange(var1) %>%
    mutate("{var1}_rank" := rank(-!!sym(var1)), na.last = "keep") %>%
#    arrange(var2) %>%
    mutate("{var2}_rank"  := rank(-!!sym(var2)),  na.last = "keep")  %>%
     mutate(rank_diff = !!sym(glue("{var2}_rank")) - !!sym(glue("{var1}_rank" ))) %>%
   group_by(EIN) %>%
   mutate(sum_pos = sum(rank_diff >0, na.rm=TRUE),
          sum_neg = sum(rank_diff < 0,  na.rm=TRUE),
          sum_zero = sum(rank_diff ==0, na.rm=TRUE))%>%
     ungroup() %>% 
   mutate(prop_positive = sum_pos / (sum_pos + sum_neg + sum_zero),
          prop_same = sum_zero / (sum_pos + sum_neg + sum_zero) ) %>%
  select(prop_positive, organization_name, sum_pos, sum_neg, sum_zero)  %>%
  distinct()




##############################################################
# BARPLOT TO SUMMARIZE RELATIONSHIPS BY ORGANIZATION
##############################################################



prop_balanced_ranked_higher %>%
  select(contains("sum"), organization_name, prop_positive) %>%
  pivot_longer(contains('sum')) %>% group_by(organization_name) %>%
  mutate(n_years = sum(value)) %>%
  mutate(prop = value/n_years,
         m=max(prop)) %>%
  mutate(name = case_when(
    name == "sum_pos" ~ "Beginning of Year Balance\nRanked Higher than Contributions",
    name == "sum_neg" ~ "Contributions Ranked Higher\nthan Beginning of Year Balance",
    name == "sum_zero" ~"Ranked the Same"
  )) %>%
  ggplot(aes(y = fct_reorder(organization_name,prop_positive),x=  prop, fill=name)) +
  geom_bar(position="stack", stat="identity") +
 # geom_point(aes(x=prop_positive), size = .8) +
  labs(x = "Proportion",
    title = paste0("Proportion of Years Where Beginning of Year Balance\n",
    "Ranked Higher, Lower, or the Same as Contributions"),
    y = "",
    fill = "") +
  theme_c(legend.spacing.y = unit(.9, 'cm'),
          legend.text = element_text(size = 16)) + 
  theme( plot.title = element_text(size = 20, margin=margin(1,1,0,1)),
         axis.text.y = element_text(size = 16)) +
  scale_fill_manual(values = c("#5191B0",  "#B05162", "#51B09A")) +
    guides(fill = guide_legend(byrow = TRUE))+
  scale_x_continuous(expand=c(0,0))


```

```{r, fig.width= 18, fig.height=6, eval=FALSE}


# horizontal version of plot
prop_balanced_ranked_higher %>%
  select(contains("sum"), organization_name, prop_positive) %>%
  pivot_longer(contains('sum')) %>% group_by(organization_name) %>%
  mutate(n_years = sum(value)) %>%
  mutate(prop = value/n_years,
         m=max(prop)) %>%
  mutate(name = case_when(
    name == "sum_pos" ~ "Beginning of Year Balance\nRanked Higher than Contributions",
    name == "sum_neg" ~ "Contributions Ranked Higher\nthan Beginning of Year Balance",
    name == "sum_zero" ~"Ranked the Same"
  )) %>%
  ggplot(aes(x = fct_reorder(organization_name,prop_positive),y=  prop, fill=name)) +
  geom_bar(position="stack", stat="identity",color ="darkgray") +
 # geom_point(aes(x=prop_positive), size = .8) +
  labs(x = "Proportion",
    title = "Proportion of Years Where Beginning of Year Balance\nRanked Higher than Contributions",
    y = "",
    fill = "") +
  theme_c(legend.spacing.y = unit(.9, 'cm'),
          legend.text = element_text(size = 16)) + 
  theme( plot.title = element_text(size = 20, margin=margin(1,1,0,1)),
         axis.text.x = element_text(size = 18,angle=30, hjust=1, vjust =.95),
         legend.position="top") +
  scale_fill_manual(values = c("#5191B0",  "#B05162", "#51B09A")) +
    guides(fill = guide_legend(byrow = TRUE)) +
  scale_y_continuous(expand=c(0,0))

```


## Beginning of Year Balance versus Other Expenditures

```{r, fig.width =15, fig.height=7}


plot_ranks_by_consistency("BeginningYearBalanceAmt",
                          "OtherExpendituresAmt",
                           data = endowment_data_wide)+
  labs(title = "Rank of Other Expenditures versus\nRank of Beginning of Year Endowment Balance",
       y = "Rank of Other Expenditures",
       x = "Rank of Beginning of Year Balance",
       color = "Proportion of Years Where\nBeginning of Year Balance\nRanked Higher than\nOther Expenditures") + 
  theme(axis.text.x = element_text(size =9),
        axis.text.y=  element_text(size =9),
         axis.title = element_text(size=20),
        legend.text = element_text(size = 12),
         legend.title=element_text(size = 16),
        strip.text=element_text(size = 16, color = "white"),
        plot.title=element_text(hjust = .5, face="bold", size = 25))
 

```


```{r contributions barplot, fig.cap = "\\label{fig:balanceexpbar} Comparing the proportion of years where a company ranked higher, lower, or the same in beginning of year balance compared to expenditures.", fig.height= 10, fig.width=15}


##############################################################
# BARPLOT TO SUMMARIZE RELATIONSHIPS BY ORGANIZATION
##############################################################

var1 <- "BeginningYearBalanceAmt"
var2 <- "OtherExpendituresAmt"


prop_balanced_ranked_higher <- endowment_data_wide %>%
     filter(fiscal_year > 2010 & fiscal_year < 2021) %>%
    group_by(fiscal_year) %>%
   # arrange(var1) %>%
    mutate("{var1}_rank" := rank(-!!sym(var1)), na.last = "keep") %>%
#    arrange(var2) %>%
    mutate("{var2}_rank"  := rank(-!!sym(var2)),  na.last = "keep")  %>%
     mutate(rank_diff = !!sym(glue("{var2}_rank")) - !!sym(glue("{var1}_rank" ))) %>%
   group_by(EIN) %>%
   mutate(sum_pos = sum(rank_diff >0, na.rm=TRUE),
          sum_neg = sum(rank_diff < 0,  na.rm=TRUE),
          sum_zero = sum(rank_diff ==0, na.rm=TRUE))%>%
     ungroup() %>% 
   mutate(prop_positive = sum_pos / (sum_pos + sum_neg + sum_zero),
          prop_same = sum_zero / (sum_pos + sum_neg + sum_zero) ) %>%
  select(prop_positive, prop_same, organization_name, sum_pos, sum_neg, sum_zero)  %>%
  distinct()



prop_balanced_ranked_higher %>%
  select(contains("sum"), organization_name, prop_positive, prop_same) %>%
  pivot_longer(contains('sum')) %>% group_by(organization_name) %>%
  mutate(n_years = sum(value)) %>%
  mutate(prop = value/n_years,
         m=max(prop)) %>%
  mutate(name = case_when(
    name == "sum_pos" ~ "Beginning of Year Balance\nRanked Higher than Other Expenditures",
    name == "sum_neg" ~ "Other Expenditures Ranked Higher\nthan Beginning of Year Balance",
    name == "sum_zero" ~"Ranked the Same"
  )) %>%
  ggplot(aes(y = fct_reorder(organization_name,prop_positive),x=  prop, fill=name)) +
  geom_bar(position="stack", stat="identity", color ="darkgray") +
 # geom_point(aes(x=prop_positive), size = .8) +
  labs(x = "Proportion",
    title = paste0("Proportion of Years Where Beginning of Year Balance\n",
    "Ranked Higher, Lower, or the Same as Other Expenditures"),
    y = "",
    fill = "") +
  theme_c(legend.spacing.y = unit(.9, 'cm'),
          legend.text = element_text(size = 16)) + 
  theme( plot.title = element_text(size = 20, margin=margin(1,1,0,1)),
         axis.text.y = element_text(size = 16)) +
  scale_fill_manual(values = c("#5191B0",  "#B05162", "#51B09A")) +
    guides(fill = guide_legend(byrow = TRUE, ))+
  scale_x_continuous(expand=c(0,0))

```


## How ranks change over time 

## Ranking of Endowment Beginning of Year Balance 


```{r, fig.height = 8, fig.cap="\\label{fig:rank-endowments}Rank of the endowment beginning of year balance over time. The 15 companies with the most variability in ranking, defined as the mean difference in rankings between fiscal years, are shown in color. Names of all companies are on the right.", results='hide'}



######################################################
# RANK OVER TIME FOR BEGINNING OF YEAR BALANCE
######################################################




pal1 <- viridis_pal(option="mako", end = .8, begin=.2)(4)
pal2 <- viridis_pal(option="rocket", end = .8, begin=.2)(4)
pal3 <- viridis_pal(option="magma", end = .8, begin=.2)(4)
pal4 <- viridis_pal(option="inferno", end = .8, begin=.2)(4)



set.seed(123)
pal <- c(pal1, pal2, pal3, pal4)
indexes <- sample.int(length(pal), replace=FALSE)
pal <- pal[indexes]



var <- "BeginningYearBalanceAmt"


balance_ranks <- endowment_data_wide %>%
    filter(fiscal_year >=2011 & fiscal_year <=2020) %>%
    group_by(fiscal_year) %>%
    mutate(rank = rank(-!!sym(var), na.last = "keep")) %>%
    filter(!is.na(rank)) %>%
     select(organization_name,rank,fiscal_year, ContributionsAmt) %>%
    group_by(organization_name) %>%
    arrange(fiscal_year) %>%
    mutate(rankdiff = rank-lag(rank, n=1, order_by=fiscal_year),
           n_years_on_file = n()) %>%
    mutate(mean_diff = mean(abs(rankdiff),na.rm=TRUE)) %>%
  ungroup() 
 # group_by(organization_name) %>%
  

cont_ranks <-endowment_data_wide %>%
  select(organization_name, ContributionsAmt) %>%
  group_by(organization_name) %>%
  summarize(cont = mean(ContributionsAmt,na.rm=TRUE)) %>%
  ungroup() %>%
  mutate(cont_rank = rank(-cont, na.last="keep"))
 

balance_ranks <- balance_ranks %>% 
  left_join(cont_ranks)


 top_ranks <- balance_ranks %>% 
   filter(n_years_on_file>=5) %>%
   select(organization_name,mean_diff) %>%
   distinct() %>%
   arrange(desc(abs(mean_diff))) %>%
   slice_head(n=15)
 
 
 labels <- balance_ranks %>%
   mutate(color_org = ifelse(organization_name %in% top_ranks$organization_name, organization_name, NA),
          alph =is.na(color_org)) %>%
   group_by(organization_name) %>%
   mutate(minyear = min(fiscal_year,na.rm=TRUE),
          maxyear = max(fiscal_year, na.rm=TRUE)) %>%
   filter(!is.na(color_org)) %>%
   filter(fiscal_year == minyear) %>%
   select(organization_name, minyear, rank) %>%
   distinct()
 
 
 
 labels_all <- balance_ranks %>%
   mutate(color_org = ifelse(organization_name %in% top_ranks$organization_name, organization_name, NA),
          alph =is.na(color_org)) %>%
   group_by(organization_name) %>%
   mutate(minyear = min(fiscal_year,na.rm=TRUE),
          maxyear = max(fiscal_year, na.rm=TRUE)) %>%
   mutate(organization_name = ifelse(maxyear == 2020, organization_name, NA)) %>%
 #  filter(!is.na(color_org)) %>%
   filter(fiscal_year == maxyear) %>%
   select(organization_name, minyear, rank,cont_rank) %>%
   distinct()
 
 balance_ranks %>%
   mutate(color_org = ifelse(organization_name %in% top_ranks$organization_name, organization_name, NA),
          alph =is.na(color_org)) %>%
   group_by(organization_name) %>%
   mutate(minyear = min(fiscal_year,na.rm=TRUE)) %>%
    ggplot(aes(x=fiscal_year, y = rank)) +
       geom_line(aes(group=organization_name)) +
    geom_line(aes(group=organization_name, alpha = alph), linewidth=.5, color="gray") +
    geom_line(aes(group=organization_name,color =color_org), linewidth=1.3) +
    scale_alpha_manual(values =c('TRUE' = 1, 'FALSE'=.01), guide="none") +
    geom_point(alpha = .3, size =.5) +
    scale_color_manual(values=pal, na.value=NA, breaks =top_ranks$organization_name) +
    theme_c() +
    scale_y_reverse(n.breaks = 10) +
    scale_x_continuous(breaks=2010:2020,limits=c(2010,2022)) +
    labs(y = paste("Rank of ", var),
         x = "Fiscal Year",
         title = paste0("Rank over time for ", var)) +
   geom_label(aes(x=minyear, y =rank,
                  label=organization_name,
                  color=organization_name), 
              nudge_x = -.3,
              alpha = 1,
              size = 3,
              label.padding=unit(.1,'lines'),
              label.size=1.2,
              data=labels) +
   geom_label(aes(x = minyear,
                  label = organization_name,
              #  color=organization_name,
                 y =rank),
              nudge_x = -.3,
              color = "black",
              size=3,
             label.size = NA,
             label.padding= unit(.1,'lines'),
             data=labels) +
   theme(axis.title = element_text(size =26),
         plot.title = element_text(size = 26, margin = margin(0,0,4,0)),
         axis.text.x = element_text(size=14),
         legend.position = "none") +
   labs(title = "Rank of Beginning of Year Balance over Time",
        x = "Fiscal Year",
        y = "Rank of Beginning of Year Balance") +
   geom_text(aes(x=2020, label = organization_name, y  = rank), 
             data=labels_all, nudge_x=.1, size = 2.85, hjust=0)
 
 
balance_ranks %>%
   mutate(color_org = ifelse(organization_name %in% top_ranks$organization_name, organization_name, NA),
          alph =is.na(color_org)) %>%
   group_by(organization_name) %>%
   mutate(minyear = min(fiscal_year,na.rm=TRUE),
          maxyear = max(fiscal_year, na.rm=TRUE)) %>%
  filter(fiscal_year == minyear | fiscal_year == maxyear) %>% 
  mutate(year = ifelse(fiscal_year == minyear, "min", "max")) %>%
  select(organization_name, rank, year) %>%
  pivot_wider(names_from=year, values_from= rank) %>%
  mutate(difference = max - min) %>%
  arrange(desc(abs(difference)))


```



```{r, fig.height =7, fig.cap="\\label{fig:rank-endowments-color-contribution}Rank of the endowment beginning of year balance over time, where the color indicates the ranking of the mean contributions received over all years on file for the company."}




##############################
# COLOR BY CONTRIBUTIONS
##############################


 balance_ranks %>%
   mutate(color_org = ifelse(organization_name %in% top_ranks$organization_name, organization_name, NA),
          alph =is.na(color_org)
        #  cont_rank = factor(cont_rank)
          ) %>%
   # mutate(minyear = min(fiscal_year,na.rm=TRUE)
   #        contsum = sum(ContributionsAmt, )) %>%
    ggplot(aes(x=fiscal_year,
               y = rank, 
               color = cont_rank, 
               group=organization_name, 
               fill=cont_rank)) +
   geom_line(aes(linewidth=1/cont_rank, group=organization_name)) +
   scale_linewidth_continuous(range = c(.1,1.6), guide="none") +
#   scale_color_steps2(high="#091F74", low="#CB1C1C", mid="lightgray", n.breaks=13, midpoint=5) +
    # geom_point(alpha = .3, size =.5) +
   scale_color_viridis(option="mako",
                       direction = -1,
                       trans="reverse",
                       breaks = c(5,40),
                       labels = c("Ranked Higher", "Ranked Lower"),
                     #  trans="exp",
                      # discrete=TRUE,
                     #  trans="sqrt",
                     #  direction=-1,
                     #  breaks = c(2.5,5), 
                    #   labels=list("Higher Ranked", "Lower Ranked"),
                       end=.9,
                    begin=.2) +
 #   scale_color_manual(values=pal, na.value=NA, breaks =top_ranks$organization_name) +
    theme_c() +
    scale_y_reverse(n.breaks = 10) +
    scale_x_continuous(breaks=2010:2020,limits=c(2010,2022)) +
    labs(y = paste("Rank of ", var),
         x = "Fiscal Year",
         title = paste0("Rank over time for ", var),
         fill = "Rank of the Sum of All Contributions over Time") +
   theme(axis.title = element_text(size =26),
         plot.title = element_text(size = 26, margin = margin(0,0,4,0)),
         axis.text.x = element_text(size=14),
         legend.text=element_text(size = 18),
         legend.title = element_text(size = 20, face="bold")) +
   labs(title = "Rank of Beginning of Year Balance over Time",
        x = "Fiscal Year",
        y = "Rank of Beginning of Year Balance",
        color = "Rank of Contributions") +
   geom_text(aes(x=2020, label = organization_name, y  = rank), 
             data=labels_all, nudge_x=.1, size = 2.85, hjust=0) 
 
 
 
    
    
    
 # 
 # 
 # plt <- balance_ranks %>%
 #   mutate(color_org = ifelse(organization_name %in% top_ranks$organization_name, organization_name, NA),
 #          alph =is.na(color_org)) %>%
 #   group_by(organization_name) %>%
 #   mutate(minyear = min(fiscal_year,na.rm=TRUE)) %>%
 #    ggplot(aes(x=fiscal_year, y = rank)) +
 #       geom_line(aes(group=organization_name)) 

```




```{r, fig.height=7, fig.width=14, fig.cap ="\\label{fig:rankings-contributions}The rankings of contributions over time, by organization."}



#######################################
# CREATE BIG PALETTE WITH MANY COLORS
#######################################

pal1 <- viridis_pal(option="mako", end = .9)(12)
pal2 <- viridis_pal(option="rocket", end = .8)(12)
pal3 <- viridis_pal(option="magma", end = .8)(12)
pal4 <- viridis_pal(option="inferno", end = .8)(12)

set.seed(123)
pal <- c(pal1, pal2, pal3, pal4)
indexes <- sample.int(length(pal), replace=FALSE)
pal <- pal[indexes]



#############################################
# RANK OVER TIME FOR CONTRIBUTIONS
#############################################


var <- "ContributionsAmt"


balance_ranks <- endowment_data_wide %>%
    filter(fiscal_year >=2011 & fiscal_year <=2020) %>%
    group_by(fiscal_year) %>%
    mutate(rank = rank(-!!sym(var), na.last = "keep")) %>%
    filter(!is.na(rank)) %>%
     select(organization_name,rank,fiscal_year, ContributionsAmt) %>%
    group_by(organization_name) %>%
    arrange(fiscal_year) %>%
    mutate(rankdiff = rank-lag(rank, n=1, order_by=fiscal_year),
           n_years_on_file = n()) %>%
    mutate(mean_diff = mean(abs(rankdiff),na.rm=TRUE)) %>%
  ungroup() 
 # group_by(organization_name) %>%
  
 
 top_ranks <- balance_ranks %>% 
   filter(n_years_on_file>=5) %>%
   select(organization_name,mean_diff) %>%
   distinct() %>%
   arrange(desc(abs(mean_diff))) %>%
   slice_head(n=15)
 
 
 labels <- balance_ranks %>%
   mutate(color_org = ifelse(organization_name %in% top_ranks$organization_name, organization_name, NA),
          alph =is.na(color_org)) %>%
   group_by(organization_name) %>%
   mutate(minyear = min(fiscal_year,na.rm=TRUE),
          maxyear = max(fiscal_year, na.rm=TRUE)) %>%
   filter(!is.na(color_org)) %>%
   filter(fiscal_year == minyear) %>%
   select(organization_name, minyear, rank) %>%
   distinct()
 
 
 
 labels_all <- balance_ranks %>%
   mutate(color_org = ifelse(organization_name %in% top_ranks$organization_name, organization_name, NA),
          alph =is.na(color_org)) %>%
   group_by(organization_name) %>%
   mutate(minyear = min(fiscal_year,na.rm=TRUE),
          maxyear = max(fiscal_year, na.rm=TRUE)) %>%
   mutate(organization_name = ifelse(maxyear == 2020, organization_name, NA)) %>%
 #  filter(!is.na(color_org)) %>%
   filter(fiscal_year == maxyear) %>%
   select(organization_name, minyear, rank) %>%
   distinct()
 
 balance_ranks %>%
   group_by(organization_name) %>%
   mutate(minyear = min(fiscal_year,na.rm=TRUE)) %>%
    ggplot(aes(x=fiscal_year, y = rank, color = organization_name, group = organization_name)) +
       geom_line() +
   # scale_alpha_manual(values =c('TRUE' = 1, 'FALSE'=.01), guide="none") +
    geom_point(alpha = .3, size =.5) +
    scale_color_manual(values=pal, na.value=NA) +
    theme_c() +
    scale_y_reverse(n.breaks = 10) +
    scale_x_continuous(breaks=2011:2020,limits=c(2010,2022)) +
    labs(y = paste("Rank of ", var),
         x = "Fiscal Year",
         title = paste0("Rank over time for ", var)) +
   # geom_label(aes(x=minyear, y =rank,
   #                label=organization_name,
   #                color=organization_name), 
   #            nudge_x = -.3,
   #            alpha = 1,
   #            label.size=1.5,
   #            data=labels) +
   geom_text_repel(aes(x = 2020,
                  label = organization_name,
                  color=organization_name,
              #  color=organization_name,
                 y =rank),
              direction="y",
              nudge_x = .1,
        #      color = "black",
           #  label.size = NA,
             hjust = 0,
             min.segment.length = .7,
             size =3.4,
             data=labels_all) +
   theme(axis.title = element_text(size =22),
         plot.title = element_text(size = 24, margin = margin(0,0,4,0)),
         axis.text.x = element_text(size=14),
         legend.position = "none") +
   labs(title = "Rank of Contributions over Time",
        x = "Fiscal Year",
        y = "Rank of Contributions") 

 
 

 
# balance_ranks %>%
#    mutate(color_org = ifelse(organization_name %in% top_ranks$organization_name, organization_name, NA),
#           alph =is.na(color_org)) %>%
#    group_by(organization_name) %>%
#    mutate(minyear = min(fiscal_year,na.rm=TRUE),
#           maxyear = max(fiscal_year, na.rm=TRUE)) %>%
#   filter(fiscal_year == minyear | fiscal_year == maxyear) %>% 
#   mutate(year = ifelse(fiscal_year == minyear, "min", "max")) %>%
#   select(organization_name, rank, year) %>%
#   pivot_wider(names_from=year, values_from= rank) %>%
#   mutate(difference = max - min) %>%
#   arrange(desc(abs(difference)))



 
```


```{r,  results='asis', fig.height = 8, out.width="90%", eval=FALSE}
# 
# 
# rankings_over_time <- endowment_data_wide %>%
#   filter(fiscal_year >=2011 & fiscal_year <=2020) %>%
#   group_by(fiscal_year) %>%
#   mutate(rank = rank(-BeginningYearBalanceAmt, na.last = "keep")) %>%
#   filter(!is.na(rank)) %>%
#   ggplot(aes(x=fiscal_year, y = rank, color =organization_name)) +
#   geom_line() +
#   scale_color_viridis(option = "rocket", discrete=TRUE) +
#   theme_c()
# 
# ggplotly(rankings_over_time, margin = m, height = 550) 


plot_ranks_over_time <- function(dat,var) {
  dat %>%
    filter(fiscal_year >=2011 & fiscal_year <=2020) %>%
    group_by(fiscal_year) %>%
    mutate(rank = rank(-!!sym(var), na.last = "keep")) %>%
    filter(!is.na(rank)) %>%
    ggplot(aes(x=fiscal_year, y = rank, color =organization_name)) +
    geom_line() +
    geom_point(alpha = .3, size =.5) +
    scale_color_viridis(option = "rocket", discrete=TRUE) +
    theme_c() +
    scale_y_continuous(n.breaks = 10) +
    scale_x_continuous(breaks=2011:2020) +
    labs(y = paste("Rank of ", var),
         x = "Fiscal Year",
         title = paste0("Rank over time for ", var))
}

plotlist <- map(vars,~ {
  plt<- plot_ranks_over_time(endowment_data_wide,.x) %>% partial_bundle()
})


htmltools::tagList(setNames(plotlist, NULL))





```



