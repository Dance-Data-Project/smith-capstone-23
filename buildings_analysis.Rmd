---
title: "test"
author: "Zhen Nie"
date: '`r Sys.Date()`'
output: html_document
---

```{r}
source("GET_VARS.R")
library(rmarkdown)
library(here)
library(tibble)
library(dplyr)
library(ggplot2)
library(viridis)
```

## Infrastructure

```{r}
make_table <- function(df, title = "", ...) {
  title <- paste0("<center><span style = 'font-size:160%;color:black'><b>",
                  title,
                  "</span></b><center>")
   as_tibble(df) %>%
    kbl(caption = title, ... ) %>%
    kable_material() %>%
    row_spec(row=0, background = "#43494C" , color = "white", bold = TRUE)
}
```

```{r,eval=FALSE}
schedule_d <- map_df(files, ~get_df(filename = .x , 
                              schedule = 'd')) %>%
  filter_ein()

schedule_d %>%
  # remove /Return/ReturnData/IRS990ScheduleD/ from columns since this is shared
  # across all columns
  rename_with(~gsub("/Return/ReturnData/IRS990ScheduleD/", "", .))
  
companies<-read.csv(here("data","companies.csv")) %>% select(organization_name, EIN) %>% mutate(EIN=as.character(EIN))

buildings<-schedule_d[,c(1,35,2,5,86,87,124,159,160)] %>% 
  left_join(companies, by = "EIN") %>% 
  rename_with(~gsub("/Return/ReturnData/IRS990ScheduleD/", "", .)) %>% 
  filter(!is.na(organization_name)) %>% 
  mutate(fiscal_year = as.numeric(as.character(fiscal_year)))

saveRDS(buildings, "data/buildings.RDS")
```

## Overall Visualizations
```{r}
ggplot(buildings, aes(x = fiscal_year, y = as.numeric(TotalBookValueLandBuildingsAmt), color = as.factor(organization_name)))+
  theme_bw()+
  geom_line()+
  #geom_point()+
  scale_color_viridis(discrete=TRUE, option="A")+
  theme(legend.key.size = unit(1, "mm"),
        legend.text = element_text(size = 2))+
  labs(x = "Fiscal Year",
       y = "Total Book Values of Land and Buildings",
       color = "Company Name")

```

```{r}
high <- buildings %>% 
  mutate(quantile = ntile(TotalBookValueLandBuildingsAmt, 12)) %>% 
  filter(quantile >= 9)

medium <- buildings %>% 
  mutate(quantile = ntile(TotalBookValueLandBuildingsAmt, 12)) %>% 
  filter(quantile > 4 & quantile < 9)

low <- buildings %>% 
  mutate(quantile = ntile(TotalBookValueLandBuildingsAmt, 12)) %>% 
  filter(quantile <= 4)
```


```{r}

  ggplot(high,aes(x = fiscal_year, y=as.numeric(TotalBookValueLandBuildingsAmt), color=organization_name))+
    geom_line()+
    geom_point()+
    theme_bw()+
    scale_color_viridis(discrete=TRUE,begin=.2,end=.8,option="A")+
    labs(x = "Fiscal Year", y = "Total Book Value Land Buildings Amount", 
         color = "Company Name")+
    theme(legend.key.size = unit(1, "mm"),
        legend.text = element_text(size = 2))

```

```{r}

ggplot(medium, aes(x = fiscal_year, 
                   y = as.numeric(as.character(TotalBookValueLandBuildingsAmt)), 
                   color = as.factor(organization_name)))+
    geom_line()+
    geom_point()+
    theme_bw()+
    scale_color_viridis(discrete=TRUE,begin=.2,end=.8,option="A")+
    labs(x = "Fiscal Year", y = "Total Book Value Land Buildings Amount", 
         color = "Company Name")+
    theme(legend.key.size = unit(1, "mm"),
        legend.text = element_text(size = 2))

```

```{r}

  ggplot(low, aes(x = (fiscal_year), y = as.numeric(as.character(TotalBookValueLandBuildingsAmt)), color = as.factor(organization_name)))+
    #geom_line()+
    geom_point()+
    theme_bw()+
    scale_color_viridis(discrete=TRUE,begin=.2,end=.8,option = "A")+
    labs(x = "Fiscal Year", y = "Total Book Value Land Buildings Amount")+
    theme(legend.key.size = unit(1, "mm"),
        legend.text = element_text(size = 2))

```


```{r}
buildings %>% 
  group_by(fiscal_year) %>% 
  summarise(
    `Reporting companies number` = n(),
    Mean = mean(as.numeric(TotalBookValueLandBuildingsAmt), na.rm=TRUE),
    Median = median(as.numeric(TotalBookValueLandBuildingsAmt),na.rm=TRUE),
    Max = max(as.numeric(TotalBookValueLandBuildingsAmt),na.rm=TRUE),
    Min = min(as.numeric(TotalBookValueLandBuildingsAmt),na.rm=TRUE)
  ) 
```
## Percentage Change
```{r}
options(scipen = 999, digits = 3)
changes<-buildings %>% 
  group_by(organization_name) %>% 
  mutate(change = (as.numeric(TotalBookValueLandBuildingsAmt) - lag(as.numeric(TotalBookValueLandBuildingsAmt))) / lag(as.numeric(TotalBookValueLandBuildingsAmt)) * 100) %>%
  mutate(change_abs = abs(change))
changes <- changes[,c(1,2,3,10,11,12)]

```

```{r}
# change overall
  ggplot(changes, aes(x = fiscal_year, y = change, color = as.factor(organization_name)))+
    geom_point()+
    geom_line(stat = "identity")+
    theme_bw()+
    scale_color_viridis(discrete=TRUE,begin=.2,end=.8,option = "A")+
    labs(x = "Fiscal Year", y = "Total Book Value Land Buildings Amount",
         color = "Company Name")+
    theme(legend.key.size = unit(1, "mm"),
        legend.text = element_text(size = 2))

```

```{r}
smaller<-changes %>% 
  filter(change_abs <= 100)

bigger<-changes %>% 
  filter(change_abs > 100)
```

```{r}
#change smaller than 100%
  ggplot(smaller, aes(x = (fiscal_year), y = change, color = as.factor(organization_name)))+
    geom_point()+
    geom_line(stat = "identity")+
    theme_bw()+
    scale_color_viridis(discrete=TRUE,begin=.2,end=.8,option = "A")+
    labs(x = "Fiscal Year", y = "Book Value Land Buildings Amount % Change", 
         color = "Company Name")+
    theme(legend.key.size = unit(1, "mm"),
        legend.text = element_text(size = 2))

```

```{r}
# changes larger than 100%
  ggplot(bigger, aes(x = (fiscal_year), y = change, color = as.factor(organization_name)))+
    geom_point()+
    geom_line()+
    theme_bw()+
    scale_color_viridis(discrete=TRUE,begin=.2,end=.8,option = "A")+
    labs(x = "Fiscal Year", y = "Total Book Value Land Buildings Amount")+
    theme(legend.key.size = unit(1, "mm"),
        legend.text = element_text(size = 2))

```


```{r}
negative <-changes %>% 
  filter(change <0)


positive <-changes %>% 
  filter(change >0)
```

```{r}
# negative changes
  ggplot(negative, aes(x = (fiscal_year), y = change, color = as.factor(organization_name)))+
    geom_point()+
    geom_line(stat = "identity")+
    theme_bw()+
    scale_color_viridis(discrete=TRUE,begin=.2,end=.8,option = "A")+
    labs(x = "Fiscal Year", y = "Companies with Negative % Change in Book Value Land Buildings Amount",
         color = "Company Name")+
    theme(legend.key.size = unit(1, "mm"),
        legend.text = element_text(size = 2))
```

```{r}

  ggplot(positive, aes(x = (fiscal_year), y = change, color = as.factor(organization_name)))+
    geom_point()+
    geom_line(stat = "identity")+
    theme_bw()+
    scale_color_viridis(discrete=TRUE,begin=.2,end=.8,option = "A")+
    labs(x = "Fiscal Year", y = "Companies with Postivie Change in Book Value Land Buildings Amount")+
   theme(legend.key.size = unit(1, "mm"),
        legend.text = element_text(size = 2))
```
```{r}
positive %>% 
  select(fiscal_year, organization_name) %>% 
  unique()
```

```{r}
changes %>% 
  filter(change != Inf) %>% 
  group_by(fiscal_year) %>% 
  summarise(
    Mean = mean(change, na.rm=TRUE),
    Median = median(change,na.rm=TRUE),
    Max = max(change,na.rm=TRUE),
    Min = min(change,na.rm=TRUE)
  )
```

```{r}
changes %>% 
  filter(change > 100) %>% 
  select(organization_name, fiscal_year, change) %>% 
  arrange(desc(change))
```

```{r}
changes %>% 
  arrange(desc(change)) %>% 
  na.omit() %>% 
  filter(change>100) %>% 
  select(fiscal_year, organization_name,change)
```

```{r}
changes %>% 
  arrange(desc(change)) %>% 
  na.omit() %>% 
  filter(change<100) %>% 
  select(fiscal_year, organization_name,change)
```

## Regional Analysis

```{r}
state<-readRDS(here("data","ein_to_state_update.RDS"))
buildings<-buildings %>% 
  left_join(state, by = "EIN")
```

```{r}
buildings %>% 
  group_by(state, fiscal_year) %>% 
  summarise(
    mean = mean(as.numeric(TotalBookValueLandBuildingsAmt), na.rm=TRUE),
    median = median(as.numeric(TotalBookValueLandBuildingsAmt), na.rm=TRUE),
    max = max(as.numeric(TotalBookValueLandBuildingsAmt), na.rm=TRUE),
    min = min(as.numeric(TotalBookValueLandBuildingsAmt), na.rm=TRUE)
  ) %>% 
  arrange(desc(median)) %>% 
  ggplot(aes(x = fiscal_year, y = median, color = state))+
  geom_point()+
  geom_line()+
  theme_bw()+
  scale_color_viridis(discrete=TRUE, option = "A")+
  labs(x = "Fiscal Year", y = "Median of Building Book Values",color = "State")
```
```{r}
buildings %>% 
  group_by(state, fiscal_year) %>% 
  summarise(
    mean = mean(as.numeric(TotalBookValueLandBuildingsAmt), na.rm=TRUE),
    median = median(as.numeric(TotalBookValueLandBuildingsAmt), na.rm=TRUE),
    max = max(as.numeric(TotalBookValueLandBuildingsAmt), na.rm=TRUE),
    min = min(as.numeric(TotalBookValueLandBuildingsAmt), na.rm=TRUE),
    sum = sum(as.numeric(TotalBookValueLandBuildingsAmt), na.rm=TRUE)
  ) %>% 
  arrange(desc(sum)) %>% 
  ggplot(aes(x = fiscal_year, y = sum, color = state))+
  geom_point()+
  geom_line()+
  theme_bw()+
  scale_color_viridis(discrete = TRUE, option="A")+
  labs()
```
```{r}
buildings %>% 
  group_by(state, fiscal_year) %>% 
  summarise(
    Number = n()
  ) %>% 
  unique() %>% 
  ggplot(aes(x = fiscal_year, y = Number, color = state))+
  geom_line()+
  geom_point()+
  theme_bw()+
  scale_color_viridis(discrete = TRUE, option="A")+
  labs(x = "Fiscal Year", 
       y = "Number",
       color = "State",
       title = "Companies reporting Total Building and Land Book Values")
```
```{r}

```

