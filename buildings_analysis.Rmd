---
title: "test"
author: "Zhen Nie"
date: '`r Sys.Date()`'
output: html_document
---

```{r}
source("GET_VARS.R")
library(rmarkdown)
library(here)
library(tibble)
library(dplyr)
library(ggplot2)
library(viridis)
```

```{r}
schedule_d <- map_df(files, ~get_df(filename = .x , 
                              schedule = 'd')) %>%
  filter_ein()

schedule_d %>%
  # remove /Return/ReturnData/IRS990ScheduleD/ from columns since this is shared
  # across all columns
  rename_with(~gsub("/Return/ReturnData/IRS990ScheduleD/", "", .))
  
companies<-read.csv(here("data","companies.csv")) %>% select(organization_name, EIN) %>% mutate(EIN=as.character(EIN))

buildings<-schedule_d[,c(1,35,2,5,86,87,124,159,160)] %>% 
  left_join(companies, by = "EIN") %>% 
  rename_with(~gsub("/Return/ReturnData/IRS990ScheduleD/", "", .)) %>% 
  filter(!is.na(organization_name))

saveRDS(buildings, "data/buildings.RDS")
```


```{r}

  ggplot(buildings, aes(x = as.character(fiscal_year), y = as.numeric(as.character(TotalBookValueLandBuildingsAmt)), color = as.factor(organization_name)))+
    #geom_line()+
    geom_point()+
    theme_bw()+
    scale_color_viridis(discrete=TRUE, option= "A") +
    labs(x = "Fiscal Year", y = "Total Book Value Land Buildings Amount")

```

```{r}
high <- buildings %>% 
  mutate(quantile = ntile(TotalBookValueLandBuildingsAmt, 12)) %>% 
  filter(quantile >= 9)

medium <- buildings %>% 
  mutate(quantile = ntile(TotalBookValueLandBuildingsAmt, 12)) %>% 
  filter(quantile > 4 & quantile < 9)

low <- buildings %>% 
  mutate(quantile = ntile(TotalBookValueLandBuildingsAmt, 12)) %>% 
  filter(quantile <= 4)
```


```{r}

  ggplot(high,aes(x = fiscal_year, y=as.numeric(TotalBookValueLandBuildingsAmt), color=organization_name))+
    geom_line()+
    geom_point()+
    theme_bw()+
    scale_color_viridis(discrete=TRUE,begin=.2,end=.8,option="A")+
    labs(x = "Fiscal Year", y = "Total Book Value Land Buildings Amount")

```

```{r}

  ggplot(medium, aes(x = as.character(fiscal_year), y = as.numeric(as.character(TotalBookValueLandBuildingsAmt)), color = as.factor(organization_name)))+
    geom_line()+
    geom_point()+
    theme_bw()+
    scale_color_viridis(discrete=TRUE,begin=.2,end=.8,option="A")+
    labs(x = "Fiscal Year", y = "Total Book Value Land Buildings Amount")

```

```{r}

  ggplot(low, aes(x = as.character(fiscal_year), y = as.numeric(as.character(TotalBookValueLandBuildingsAmt)), color = as.factor(organization_name)))+
    #geom_line()+
    geom_point()+
    theme_bw()+
    scale_color_viridis(discrete=TRUE,begin=.2,end=.8,option = "A")+
    labs(x = "Fiscal Year", y = "Total Book Value Land Buildings Amount")+
  theme(legend.key.size = unit(0.5, "cm"))

```

```{r}
make_table <- function(df, title = "", ...) {
  title <- paste0("<center><span style = 'font-size:160%;color:black'><b>",
                  title,
                  "</span></b><center>")
   as_tibble(df) %>%
    kbl(caption = title, ... ) %>%
    kable_material() %>%
    row_spec(row=0, background = "#43494C" , color = "white", bold = TRUE)
}
```

```{r}
buildings %>% 
  group_by(fiscal_year) %>% 
  summarise(
    `Reporting companies number` = n(),
    Mean = mean(as.numeric(TotalBookValueLandBuildingsAmt), na.rm=TRUE),
    Median = median(as.numeric(TotalBookValueLandBuildingsAmt),na.rm=TRUE),
    Max = max(as.numeric(TotalBookValueLandBuildingsAmt),na.rm=TRUE),
    Min = min(as.numeric(TotalBookValueLandBuildingsAmt),na.rm=TRUE)
  ) 
```

```{r}
options(scipen = 999, digits = 3)
changes<-buildings %>% 
  group_by(organization_name) %>% 
  mutate(change = (as.numeric(TotalBookValueLandBuildingsAmt) - lag(as.numeric(TotalBookValueLandBuildingsAmt))) / lag(as.numeric(TotalBookValueLandBuildingsAmt)) * 100) %>%
  mutate(change_abs = abs(change))
changes <- changes[,c(1,2,3,10,11,12)]

```

```{r}

  ggplot(changes, aes(x = as.character(fiscal_year), y = change, color = as.factor(organization_name)))+
    geom_point()+
    geom_line(stat = "identity")+
    theme_bw()+
    scale_color_viridis(discrete=TRUE,begin=.2,end=.8,option = "A")+
    labs(x = "Fiscal Year", y = "Total Book Value Land Buildings Amount")

```

```{r}
smaller<-changes %>% 
  filter(change_abs <= 100)

bigger<-changes %>% 
  filter(change_abs > 100)
```

```{r}

  ggplot(smaller, aes(x = as.character(fiscal_year), y = change, color = as.factor(organization_name)))+
    geom_point()+
    geom_line(stat = "identity")+
    theme_bw()+
    scale_color_viridis(discrete=TRUE,begin=.2,end=.8,option = "A")+
    labs(x = "Fiscal Year", y = "Total Book Value Land Buildings Amount")

```

```{r}

  ggplot(bigger, aes(x = as.character(fiscal_year), y = change, color = as.factor(organization_name)))+
    geom_point()+
    geom_line(stat = "identity")+
    theme_bw()+
    scale_color_viridis(discrete=TRUE,begin=.2,end=.8,option = "A")+
    labs(x = "Fiscal Year", y = "Total Book Value Land Buildings Amount")

```


```{r}
negative <-changes %>% 
  filter(change <0)
positive <-changes %>% 
  filter(change >0)
```

```{r}

  ggplot(negative, aes(x = as.character(fiscal_year), y = change, color = as.factor(organization_name)))+
    geom_point()+
    geom_line(stat = "identity")+
    theme_bw()+
    scale_color_viridis(discrete=TRUE,begin=.2,end=.8,option = "A")+
    labs(x = "Fiscal Year", y = "Total Book Value Land Buildings Amount")
```

```{r}

  ggplot(positive, aes(x = as.character(fiscal_year), y = change, color = as.factor(organization_name)))+
    geom_point()+
    geom_line(stat = "identity")+
    theme_bw()+
    scale_color_viridis(discrete=TRUE,begin=.2,end=.8,option = "A")+
    labs(x = "Fiscal Year", y = "Total Book Value Land Buildings Amount")
```

```{r}
changes %>% 
  filter(change != Inf) %>% 
  group_by(fiscal_year) %>% 
  summarise(
    Mean = mean(change, na.rm=TRUE),
    Median = median(change,na.rm=TRUE),
    Max = max(change,na.rm=TRUE),
    Min = min(change,na.rm=TRUE)
  )
```

```{r}
changes %>% 
  filter(change > 100) %>% 
  select(organization_name, fiscal_year, change) %>% 
  arrange(desc(change))
```

```{r}
changes %>% 
  arrange(desc(change)) %>% 
  na.omit() %>% 
  filter(change>100) %>% 
  select(fiscal_year, organization_name,change)
```

```{r}
changes %>% 
  arrange(desc(change)) %>% 
  na.omit() %>% 
  filter(change<100) %>% 
  select(fiscal_year, organization_name,change)
```


