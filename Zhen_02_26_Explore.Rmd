---
title: "explore"
author: "Zhen"
date: "2023-02-26"
output:
  rmdformats::readthedown:
    df_print: paged
    code_folding: hide
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = "./output_html")})
---


```{r library}
library(dplyr)
library(purrr)
library(xml2)
library(ggplot2)
library(kableExtra)
library(shiny)
```

```{r copied from "load_wrangle_filter_data" to get the variables needed for the next chunk}
################################################################################
# extract variables in the IRS990ScheduleD node from the given file
################################################################################
# output is a dataframe with the filename and name of each variable extracted

collect_sched_d_vars <- function(input_file) {
  example_file <- xml2::read_xml(input_file)%>% xml_ns_strip()

  # look at all variable names in schedule D
  IRS990ScheduleD_vars <- example_file %>% 
    xml_find_all("//ReturnData//IRS990ScheduleD")  %>%
    xml_contents() %>% 
    xml_path() 
  
  # look at variable names of children nodes of the schedule D nodes
  IRS990ScheduleD_var_children <- IRS990ScheduleD_vars %>% 
    map(~xml_find_all(example_file,
                      xpath = gsub("/", 
                                   "//" ,
                                   .x, 
                                   fixed = TRUE) ) %>%
          xml_children() %>% 
          xml_path()) %>%
    unlist()
  
    # include both first level schedule D nodes and children nodes
    vars <- c(IRS990ScheduleD_vars, IRS990ScheduleD_var_children)
    
    tibble(variables = vars,
           filename = input_file)
}

# file paths in the directory
files <- dir( "/Users/niezhen/Desktop/Spring 2023/SDS 410/ballet_990_released_20230208",
               full.names = TRUE)

# iterate over all files and extract variables present
# output is a data frame with a file name column and variable name column
all_vars <- map_df(files, collect_sched_d_vars)

all_vars
```


```{r all the variables to add to the meta dataframe}
# after seeing the final table in the data_dictionary counting each variables's occurence, I think it can be nice to add more variables to the endowment data. Liza also mentioned that we can try to trace building endowment change over time, so I think I can try to add BuidingGrp variable into the endowment_data

# Find all variable names that include building information


all_vars <- map_df(files, collect_sched_d_vars)

to_add <- c()

for(row in 1:nrow(all_vars)){
  if(grepl("OtherLandBuildingsGrp", all_vars[row, ]$variables) | grepl("BuildingsGrp", all_vars[row, ]$variables)){
    to_add <- append(to_add, all_vars[row, ]$variables)
  }
}

to_add<-unique(to_add)
to_add
```


## Buildings Grouop Explanation
Copied from https://www.irs.gov/pub/irs-pdf/i990sd.pdf

Part VI. Land, Buildings, and Equipment
Complete Part VI if the organization answered “Yes” on Form 990, Part IV, line 11a, and reported an amount on Form 990, Part X, line 10a. Reporting is required if any amount other than zero is reported on those lines.

Column (a). Enter the cost or other basis of all land, buildings, leasehold improvements, equipment, and other fixed assets held for investment purposes, such as rental properties.

Column (b). Enter the cost or other basis of all other land, buildings, leasehold improvements, equipment, and other fixed assets held for other than investment purposes, including any land, buildings, and equipment owned and
used by the organization in conducting its exempt activities. The total amounts reported in columns (a) and (b) must equal the amount reported on Form 990, Part X, line 10a.

Column (c). Enter the accumulated depreciation recorded for the assets listed in columns (a) and (b). Don't enter an
amount in column (c) for line 1a, Land. The total of column (c) must equal the amount reported on Form 990, Part X,
line 10b.

Column (d). Enter the sum of column (a) and column (b) minus column (c). 

```{r}
##From Rose's get_endowment function
get_endowment <- function(filename) {
  
  # Retrieving the same endowment information for all 
  variables <- c("//Return//ReturnHeader//ReturnTs", 
                 "//Return//ReturnHeader//Filer//EIN", 
                 "//Return//ReturnData//IRS990//DonorRstrOrQuasiEndowmentsInd",
                 "//Return//ReturnData//IRS990ScheduleD//CYEndwmtFundGrp//BeginningYearBalanceAmt",
                 "//Return//ReturnData//IRS990ScheduleD//CYEndwmtFundGrp//ContributionsAmt",
                 "//Return//ReturnData//IRS990ScheduleD//CYEndwmtFundGrp//InvestmentEarningsOrLossesAmt",
                 "//Return//ReturnData//IRS990ScheduleD//CYEndwmtFundGrp//OtherExpendituresAmt",
                 "//Return//ReturnData//IRS990ScheduleD//CYEndwmtFundGrp//EndYearBalanceAmt",
                 
                 "//Return//ReturnData//IRS990ScheduleD//CYMinus1YrEndwmtFundGrp//BeginningYearBalanceAmt",
                 "//Return//ReturnData//IRS990ScheduleD//CYMinus1YrEndwmtFundGrp//ContributionsAmt",
                 "//Return//ReturnData//IRS990ScheduleD//CYMinus1YrEndwmtFundGrp//InvestmentEarningsOrLossesAmt",
                 "//Return//ReturnData//IRS990ScheduleD//CYMinus1YrEndwmtFundGrp//OtherExpendituresAmt",
                 "//Return//ReturnData//IRS990ScheduleD//CYMinus1YrEndwmtFundGrp//EndYearBalanceAmt",
                
                 "//Return//ReturnData//IRS990ScheduleD//CYMinus2YrEndwmtFundGrp//BeginningYearBalanceAmt",
                 "//Return//ReturnData//IRS990ScheduleD//CYMinus2YrEndwmtFundGrp//ContributionsAmt",
                 "//Return//ReturnData//IRS990ScheduleD//CYMinus2YrEndwmtFundGrp//InvestmentEarningsOrLossesAmt",
                 "//Return//ReturnData//IRS990ScheduleD//CYMinus2YrEndwmtFundGrp//OtherExpendituresAmt",
                 "//Return//ReturnData//IRS990ScheduleD//CYMinus2YrEndwmtFundGrp//EndYearBalanceAmt",
                 
                 "//Return//ReturnData//IRS990ScheduleD//CYMinus3YrEndwmtFundGrp//BeginningYearBalanceAmt",
                 "//Return//ReturnData//IRS990ScheduleD//CYMinus3YrEndwmtFundGrp//ContributionsAmt",
                 "//Return//ReturnData//IRS990ScheduleD//CYMinus3YrEndwmtFundGrp//InvestmentEarningsOrLossesAmt",
                 "//Return//ReturnData//IRS990ScheduleD//CYMinus3YrEndwmtFundGrp//OtherExpendituresAmt",
                 "//Return//ReturnData//IRS990ScheduleD//CYMinus3YrEndwmtFundGrp//EndYearBalanceAmt",
                 
                 "//Return//ReturnData//IRS990ScheduleD//CYMinus4YrEndwmtFundGrp//BeginningYearBalanceAmt",
                 "//Return//ReturnData//IRS990ScheduleD//CYMinus4YrEndwmtFundGrp//ContributionsAmt",
                 "//Return//ReturnData//IRS990ScheduleD//CYMinus4YrEndwmtFundGrp//InvestmentEarningsOrLossesAmt",
                 "//Return//ReturnData//IRS990ScheduleD//CYMinus4YrEndwmtFundGrp//OtherExpendituresAmt",
                 "//Return//ReturnData//IRS990ScheduleD//CYMinus4YrEndwmtFundGrp//EndYearBalanceAmt",
                 
                 "//Return//ReturnData//IRS990ScheduleD//BoardDesignatedBalanceEOYPct",
                 "//Return//ReturnData//IRS990ScheduleD//PrmnntEndowmentBalanceEOYPct",
                 "//Return//ReturnData//IRS990ScheduleD//TermEndowmentBalanceEOYPct",
                 "//Return//ReturnData//IRS990ScheduleD//EndowmentsHeldUnrelatedOrgInd",
                 "//Return//ReturnData//IRS990ScheduleD//EndowmentsHeldRelatedOrgInd",
                 
                 # adding BuildingGrp and OtherLandBuildingsGrp
                 "/Return/ReturnData/IRS990ScheduleD/OtherLandBuildingsGrp/OtherCostOrOtherBasisAmt",     
                 "/Return/ReturnData/IRS990ScheduleD/OtherLandBuildingsGrp/DepreciationAmt",             
                 "/Return/ReturnData/IRS990ScheduleD/OtherLandBuildingsGrp/BookValueAmt",                 
                 "/Return/ReturnData/IRS990ScheduleD/BuildingsGrp/OtherCostOrOtherBasisAmt",              
                 "/Return/ReturnData/IRS990ScheduleD/BuildingsGrp/DepreciationAmt",                       
                 "/Return/ReturnData/IRS990ScheduleD/BuildingsGrp/BookValueAmt",                          
                 "/Return/ReturnData/IRS990ScheduleD/OtherLandBuildingsGrp/InvestmentCostOrOtherBasisAmt",
                  "/Return/ReturnData/IRS990ScheduleD/BuildingsGrp/InvestmentCostOrOtherBasisAmt",         
                 
                 "//AmendedReturnInd",
                 "//Return//ReturnHeader//ReturnTypeCd"
                 )
  
  # Column name; order matters, needs to align with retrieval order
  variables_no_path <- c("ReturnTs", 
                         "EIN",
                         "DonorRstrOrQuasiEndowmentsInd",
                        "CYBeginningYearBalanceAmt", 
                        "CYContributionsAmt", 
                        "CYInvestmentEarningsOrLossesAmt",
                        "CYOtherExpendituresAmt",
                        "CYEndYearBalanceAmt",
                        
                        "CYM1BeginningYearBalanceAmt", 
                        "CYM1ContributionsAmt", 
                        "CYM1InvestmentEarningsOrLossesAmt",
                        "CYM1OtherExpendituresAmt",
                        "CYM1EndYearBalanceAmt",
                        
                        "CYM2BeginningYearBalanceAmt", 
                        "CYM2ContributionsAmt", 
                        "CYM2InvestmentEarningsOrLossesAmt",
                        "CYM2OtherExpendituresAmt",
                        "CYM2EndYearBalanceAmt",
                        
                        "CYM3BeginningYearBalanceAmt", 
                        "CYM3ContributionsAmt", 
                        "CYM3InvestmentEarningsOrLossesAmt",
                        "CYM3OtherExpendituresAmt",
                        "CYM3EndYearBalanceAmt",
                        
                        "CYM4BeginningYearBalanceAmt", 
                        "CYM4ContributionsAmt", 
                        "CYM4InvestmentEarningsOrLossesAmt",
                        "CYM4OtherExpendituresAmt",
                        "CYM4EndYearBalanceAmt",
                        
                        "BoardDesignatedBalanceEOYPct",
                        "PrmnntEndowmentBalanceEOYPct",
                        "TermEndowmentBalanceEOYPct",
                        "EndowmentsHeldUnrelatedOrgInd",
                        "EndowmentsHeldRelatedOrgInd",
                        
                         "OtherLandBuildingsGrp_OtherCostOrOtherBasisAmt",     
                         "OtherLandBuildingsGrp_DepreciationAmt",             
                         "OtherLandBuildingsGrp_BookValueAmt",                 
                         "BuildingsGrp_OtherCostOrOtherBasisAmt",              
                         "BuildingsGrp_DepreciationAmt",                       
                         "BuildingsGrp_BookValueAmt",                          
                         "OtherLandBuildingsGrp_InvestmentCostOrOtherBasisAmt",
                        "BuildingsGrp_InvestmentCostOrOtherBasisAmt",         
                        
                        "AmendedReturnInd",
                        "ReturnTypeCd"
                        )
  
  xml_file <- read_xml(filename)
  xml_file <- xml_ns_strip(xml_file)
  
  # extract each variable; if it isn't present, put NA 
  extracted <- map(variables, ~{
    value <- xml_find_all(
      xml_file, 
      xpath =.x)
    value <- ifelse(length(value) ==0, 
                    NA, 
                    xml_text(value)) })
  
   names(extracted) <- variables_no_path
   
   extracted <- extracted %>%
     as_tibble()
}
```

```{r retrieving endowment info}
##Applying get_endowment to entire output 
files <- dir( "/Users/niezhen/Desktop/Spring 2023/SDS 410/ballet_990_released_20230208",
              full.names = TRUE)

endowment_data_building <- map_df(files, ~
                     get_endowment(.x)) 

all_data<-readRDS("./data/data_990.RDS")
filter_data <- all_data %>%
  filter(ReturnTypeCd == "990" | ReturnTypeCd == "990EZ") %>%
  mutate(amended_return_filled = ifelse(!is.na(AmendedReturnInd),1, 0)) %>%
  group_by(EIN, fiscal_year) %>%
  slice_max(order_by =amended_return_filled, n = 1) %>%
  ungroup()
##Retriving Ts and EINs for filtered data 
filter_ids <- filter_data %>%
  select(ReturnTs, EIN)
## Adjusting data type, filtering to proper 990s
endowment_data_building <- endowment_data_building %>%
  mutate(ReturnDate = as.Date(ReturnTs,
                              format = "%Y-%m-%d")) %>%
  mutate(across(CYBeginningYearBalanceAmt:TermEndowmentBalanceEOYPct,
                as.numeric)) %>%
  mutate(across(c(EndowmentsHeldRelatedOrgInd, EndowmentsHeldUnrelatedOrgInd, DonorRstrOrQuasiEndowmentsInd),
                ~ifelse(.x == "true" | .x == "1", TRUE, FALSE))) %>%
  
  filter(ReturnTypeCd == "990" | ReturnTypeCd == "990EZ") %>%
  right_join(filter_ids, by = c("ReturnTs", "EIN")) %>%
  select(-c(ReturnTypeCd,AmendedReturnInd)) #Removing columns needed for filtering

saveRDS(endowment_data_building, "./data/endowment_filtered_buildings.RDS")

```


## Preliminary Analysis of PartIV Data

Term explained: 
*Book value* is an accounting term used for both a measure of a business's equity and the value of an asset as it appears on a balance sheet. As time goes on, the cost stays the same, but the accumulated depreciation increases, so the book value decreases.
```{r}
# filter out all data each year
data_each_year<-list(
  data_2015 <- filter(endowment_data_building, grepl("2015", ReturnTs)),
  data_2016 <- filter(endowment_data_building, grepl("2016", ReturnTs)),
  data_2017 <- filter(endowment_data_building, grepl("2017", ReturnTs)),
  data_2018 <- filter(endowment_data_building, grepl("2018", ReturnTs)),
  data_2019 <- filter(endowment_data_building, grepl("2019", ReturnTs)),
  data_2020 <- filter(endowment_data_building, grepl("2020", ReturnTs)),
  data_2021 <- filter(endowment_data_building, grepl("2021", ReturnTs)),
  data_2022 <- filter(endowment_data_building, grepl("2022", ReturnTs))
)


```



```{r}
BookValueSum <- list()

# restore each year's sum for each EIN's buildings bookvalue 
for(i in c(1:8)){
  data = data_each_year[[i]]
  df <- data.frame(data %>% 
    filter(!is.na(BuildingsGrp_BookValueAmt)) %>% 
    mutate_at(c("BuildingsGrp_BookValueAmt", "BuildingsGrp_DepreciationAmt"), as.numeric) %>% 
    group_by(EIN) %>% 
    summarise(
      BookValueSum = sum(BuildingsGrp_BookValueAmt)
    ) %>% 
    mutate(year = 2014+i,
           EIN = as.numeric(EIN)))
           
  #print(df)
  BookValueSum[[i]] = df
}
#  convert the list into dataframe
bookvalues <- do.call(rbind, BookValueSum)
```

I notice that bookvalue of 131882106 turned to 0 in 2018




```{r mutate bookvalue dataframe with quantile and business name}
# rank book value based on quantile
bookvalues<-bookvalues %>%
  mutate(quantile = ntile(BookValueSum, 10),
         EIN = as.character(EIN)) %>% 
  arrange(desc(EIN)) %>% 
  inner_join(y = ein_to_name, by = "EIN") 
```


```{r divide bookvalues into high medium and low}
#dataframe with higher Book Values
high <- bookvalues %>% 
  filter(year == 2020) %>% 
  filter(quantile >= 8) %>% 
  select(EIN) %>% 
  inner_join(bookvalues, by = "EIN") %>% 
  select(c(1,2,3,4,5))

medium <- bookvalues %>% 
  filter(year == 2020) %>% 
  filter(quantile > 3 & quantile < 7) %>% 
  select(EIN) %>% 
  inner_join(bookvalues, by = "EIN") %>% 
  select(c(1,2,3,4,5))
  
low <- bookvalues %>% 
  filter(year == 2020) %>% 
  filter(quantile <= 3) %>% 
  select(EIN) %>% 
  inner_join(bookvalues, by = "EIN") %>% 
  select(c(1,2,3,4,5))
```
 

```{r visualizatoins of the change in buildings book value}
# visualization of overall book value
ggplot(bookvalues, aes(x = year, y = BookValueSum, color = as.factor(EIN))) +
  geom_line()+
  theme_bw()+
  theme(plot.title = element_text(size = 10, face = "bold", hjust = .5),
        axis.title = element_text(size = 12, face = "bold"),
        plot.subtitle = element_text(size = 5, face = "italic", hjust = .5),
        axis.text.x = element_text(size = 10),
        strip.text = element_text(face="bold",size = 5)) +
  labs(y = "Schedule D Sum of Buildings Book Value",
       x = "Year",
       title = "Schedule D Sum of Buildings Book Value Change",
       subtitle = "By Fiscal Year")

```
```{r}
# separate EIN with medium and low building book value according to previous graph
# high
  ggplot(high, aes(x = year, y = BookValueSum, color = as.factor(EIN))) +
  geom_line() +
  theme_bw() +
  theme(plot.title = element_text(size = 10, face = "bold", hjust = .5),
        axis.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 5, face = "italic", hjust = .5),
        axis.text.x = element_text(size = 10),
        strip.text = element_text(face="bold",size = 5)) +
  labs(y = "Schedule D Sum of Buildings Book Value",
       x = "Year",
       title = "Schedule D Sum of Buildings Book Value Change (High)",
       subtitle = "By Fiscal Year")
```


```{r}
# medium
  ggplot(medium, aes(x = year, y = BookValueSum, color = as.factor(EIN))) +
  geom_line()+
  theme_bw() +
  theme(plot.title = element_text(size = 10, face = "bold", hjust = .5),
        axis.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 5, face = "italic", hjust = .5),
        axis.text.x = element_text(size = 10),
        strip.text = element_text(face="bold",size = 5)) +
  labs(y = "Schedule D Sum of Buildings Book Value",
       x = "Year",
       title = "Schedule D Sum of Buildings Book Value Change (Medium)",
       subtitle = "By Fiscal Year")
```


```{r}
# low
  ggplot(low, aes(x = year, y = BookValueSum, color = as.factor(EIN))) +
  geom_line()+
  theme_bw() +
  theme(plot.title = element_text(size = 10, face = "bold", hjust = .5),
        axis.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 5, face = "italic", hjust = .5),
        axis.text.x = element_text(size = 10),
        strip.text = element_text(face="bold",size = 5)) +
  labs(y = "Schedule D Sum of Buildings Book Value",
       x = "Year",
       title = "Schedule D Sum of Buildings Book Value Change (Low)",
       subtitle = "By Fiscal Year")

```
The book value will decrease because of depreciation, so the normal trend of an EIN from previous visualization should be a slight downward line. I will filter out EIN with a bizarre trend that should be :
  1) Abruptly going down
  2) going up at any point
  3) appear less than 3 years
  

Caveat: ways of splitting up
split up by quantile
add geom_point

## Unusual EIN's
```{r}
# rank book value based on quantile
EIN_appearl_less_than_3<-bookvalues %>%
  mutate(quantile = ntile(BookValueSum, 10),
         EIN = as.character(EIN)) %>% 
  group_by(EIN) %>% 
  summarise(appear_times = n()) %>% 
  filter(appear_times < 3) %>% 
  inner_join(y=ein_to_name, by = c("EIN")) %>% 
  kbl(caption = "Unusual EIN (appear less than 3 times)") %>%
  kable_material() %>%
  row_spec(row = 0, background = "red", color = "white", bold = TRUE)
```


## Percentage ranking
```{r}

```



